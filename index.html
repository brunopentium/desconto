<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <title>Desconto da Casa</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root{
        --bg:#081d1a; --card:#0f2f2a; --muted:#16433c;
        --text:#eaf7f3; --subtle:#b9d6cd;
        --gold:#d4af37; --gold-2:#b9952f;
        --shadow: 0 10px 30px rgba(0,0,0,.35); --radius:16px;
      }
      *{box-sizing:border-box} html,body{height:100%}
      body{margin:0; background:linear-gradient(180deg,#071815 0%,#0a2420 100%); color:var(--text); font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,Helvetica,sans-serif}

      .top{position:sticky; top:0; z-index:50; background:linear-gradient(90deg,#0a2621 0%,#0c302a 50%,#0a2621 100%); border-bottom:1px solid rgba(212,175,55,.18); box-shadow:var(--shadow)}
      .top-inner{max-width:1100px; margin:0 auto; padding:16px 16px; display:flex; align-items:center; gap:16px}

      .brand{display:flex; align-items:center; gap:12px; font-weight:700; letter-spacing:.3px}
      .ddc-logo{width:64px; height:64px; border-radius:14px; display:block; object-fit:cover}
      .wordmark{font-size:22px; color:var(--text)}
      .wordmark strong{color:var(--gold); font-weight:900; letter-spacing:.5px}

      .userbox{margin-left:auto; display:flex; align-items:center; gap:10px; color:var(--subtle)}
      .btn{appearance:none; border:none; cursor:pointer; border-radius:12px; padding:10px 14px; font-weight:600; transition:all .18s ease}
      .btn-primary{color:#111; background:linear-gradient(180deg, var(--gold) 0%, #c6a232 100%); box-shadow:0 6px 18px rgba(212,175,55,.25)}
      .btn-primary:hover{background:linear-gradient(180deg, var(--gold-2) 0%, #a88324 100%)}
      .btn-ghost{color:var(--gold); background:transparent; border:1px solid rgba(212,175,55,.45)}
      .btn-ghost:hover{background:rgba(212,175,55,.08)}
      .btn-small{padding:6px 10px; font-size:13px}
      
      .wrap{max-width:1100px; margin:24px auto; padding:0 16px}
      .grid{display:grid; gap:16px; grid-template-columns:1fr}
      @media(min-width:880px){ .grid{grid-template-columns:repeat(2,1fr)} }
      .card{background:linear-gradient(180deg, var(--card), #0c2723); border:1px solid rgba(212,175,55,.12); border-radius:var(--radius); padding:18px; box-shadow:var(--shadow)}
      .card-full{grid-column: 1 / -1}
      
      h1{margin:0 0 8px; font-size:22px} 
      h2,h3{margin:0 0 12px}
      h4{margin:8px 0 6px; font-size:14px; color:var(--subtle)}
      
      label{display:block; margin:10px 0 6px; color:var(--subtle); font-size:13px}
      .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
      input{flex:1 1 auto; min-width:180px; padding:12px 12px; border-radius:12px; color:var(--text); background:#0b221e; border:1px solid var(--muted); outline:none; transition:all .18s ease}
      input::placeholder{color:#7fa69c} 
      input:focus{border-color:var(--gold); box-shadow:0 0 0 3px rgba(212,175,55,.15)}
      
      .actions{display:flex; gap:10px; align-items:center; margin-top:10px}
      .muted{color:var(--subtle); font-size:13px} 
      .out{margin-top:10px; font-weight:600}
      .stack{max-width:520px; margin:32px auto; display:flex; flex-direction:column; gap:16px}

      /* Tabs */
      .tabs{display:flex; gap:8px; margin-bottom:16px; border-bottom:1px solid rgba(212,175,55,.12); overflow-x:auto}
      .tab{padding:12px 18px; cursor:pointer; border-bottom:2px solid transparent; transition:all .18s; white-space:nowrap; color:var(--subtle); font-weight:600}
      .tab:hover{color:var(--text); background:rgba(212,175,55,.05)}
      .tab.active{color:var(--gold); border-bottom-color:var(--gold)}

      /* Stats */
      .stats{display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:12px; margin-bottom:16px}
      .stat{background:#0b221e; padding:14px; border-radius:12px; border:1px solid var(--muted)}
      .stat-label{font-size:12px; color:var(--subtle); margin-bottom:4px}
      .stat-value{font-size:24px; font-weight:700; color:var(--gold)}
      .stat-sub{font-size:13px; color:var(--subtle); margin-top:2px}

      /* Table */
      .table-wrap{overflow-x:auto; margin-top:12px}
      table{width:100%; border-collapse:collapse}
      th{text-align:left; padding:10px 8px; font-size:12px; color:var(--subtle); border-bottom:1px solid var(--muted)}
      td{padding:10px 8px; border-bottom:1px solid rgba(212,175,55,.06); font-size:14px}
      tr:hover{background:rgba(212,175,55,.03)}
      .badge{display:inline-block; padding:4px 8px; border-radius:6px; font-size:11px; font-weight:600}
      .badge-credit{background:rgba(94,221,168,.15); color:#5eddaa}
      .badge-resgate{background:rgba(255,92,92,.15); color:#ff5c5c}
      .badge-ajuste{background:rgba(100,150,255,.15); color:#6496ff}

      /* Search results */
      .search-results{margin-top:8px; max-height:300px; overflow-y:auto; background:#0b221e; border:1px solid var(--muted); border-radius:12px}
      .search-item{padding:10px 12px; cursor:pointer; border-bottom:1px solid rgba(212,175,55,.06); transition:all .15s}
      .search-item:hover{background:rgba(212,175,55,.08)}
      .search-item:last-child{border-bottom:none}
      .search-cpf{font-weight:600; color:var(--gold)}
      .search-nome{font-size:14px; color:var(--text)}
      .search-saldo{font-size:12px; color:var(--subtle)}

      /* Modal */
      .modal-backdrop{position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; place-items:center; z-index:100}
      .modal{width:min(480px,92vw); background:#0e2a25; border-radius:18px; padding:18px; border:1px solid rgba(212,175,55,.22); box-shadow:var(--shadow)}
      .modal h3{margin:0 0 10px} 
      .modal p{margin:8px 0; color:var(--subtle)} 
      .modal .row-end{display:flex; justify-content:flex-end; gap:10px; margin-top:14px}

      /* Toasts */
      .toast{position:fixed; right:18px; bottom:18px; z-index:120; display:flex; flex-direction:column; gap:10px}
      .toast .t{background:#0f2f2a; border:1px solid rgba(212,175,55,.22); color:var(--text); padding:12px 14px; border-radius:12px; box-shadow:var(--shadow); min-width:240px}
      .t.ok{border-color:rgba(94,221,168,.35)} 
      .t.err{border-color:rgba(255,92,92,.45)}

      /* Loading */
      .loading{text-align:center; padding:20px; color:var(--subtle)}

      @media (max-width:520px){
        .ddc-logo{width:44px; height:44px; border-radius:12px}
        .wordmark{font-size:18px}
        .top-inner{gap:12px; padding:12px 14px}
        .stats{grid-template-columns:1fr}
      }
    </style>
  </head>
  <body>
    <div class="top">
      <div class="top-inner">
        <div class="brand">
          <img class="ddc-logo"
               src="https://lh3.googleusercontent.com/d/1vmsGM2STkfh0u-hgrKsZDw3zhTKJcEhf=w512"
               alt="Desconto da Casa" />
          <span class="wordmark"><strong>DESCONTO</strong> da Casa</span>
        </div>
        <div class="userbox">
          <span id="who">—</span>
          <button class="btn btn-ghost" onclick="logout()">Sair</button>
        </div>
      </div>
    </div>

    <!-- LOGIN -->
    <div id="loginView" class="wrap stack">
      <div class="card">
        <h1>Entrar</h1>
        <label>Usuário</label><input id="username" placeholder="ex: lojista1" />
        <label>Senha</label><input id="password" type="password" placeholder="Sua senha" />
        <div class="actions"><button class="btn btn-primary" onclick="login()">Entrar</button><span id="loginMsg" class="muted"></span></div>
      </div>
    </div>

    <!-- TROCA DE SENHA -->
    <div id="changeView" class="wrap stack" style="display:none">
      <div class="card">
        <h1>Defina sua nova senha</h1>
        <label>Nova senha</label><input id="newPass" type="password" placeholder="Mínimo 8 caracteres" />
        <label>Confirme a nova senha</label><input id="newPass2" type="password" placeholder="Repita a senha" />
        <div class="actions"><button class="btn btn-primary" onclick="changePass()">Salvar nova senha</button><span id="changeMsg" class="muted"></span></div>
      </div>
    </div>

    <!-- APP -->
    <div id="appView" class="wrap" style="display:none">
      <!-- Tabs -->
      <div class="tabs">
        <div class="tab active" onclick="switchTab('operacoes')">Operações</div>
        <div class="tab" onclick="switchTab('dashboard')">Dashboard</div>
        <div class="tab" onclick="switchTab('historico')">Histórico</div>
        <div class="tab" onclick="switchTab('clientes')">Clientes</div>
      </div>

      <!-- TAB: OPERAÇÕES -->
      <div id="tabOperacoes" class="tab-content">
        <div class="grid">
          <!-- CONSULTAR -->
          <div class="card">
            <h3>Consultar saldo</h3>
            <label>CPF</label>
            <div class="row"><input id="cpfSaldo" placeholder="000.000.000-00" inputmode="numeric" /><button class="btn btn-ghost" onclick="getSaldo()">Ver saldo</button></div>
            <div id="outSaldo" class="out"></div>
          </div>

          <!-- LANÇAR -->
          <div class="card">
            <h3>Lançar compra (gerar desconto)</h3>
            <label>CPF</label><input id="cpfCompra" placeholder="000.000.000-00" inputmode="numeric" />
            <div class="row">
              <input id="valorCompra" placeholder="Valor da compra (R$)" inputmode="numeric" />
              <input id="notaRef" placeholder="Nota Ref (opcional)" />
            </div>
            <div class="actions"><button id="btnLancar" class="btn btn-primary" onclick="lancar()">Lançar</button><span id="outCompra" class="out"></span></div>
          </div>

          <!-- RESGATAR -->
          <div class="card">
            <h3>Resgatar saldo (dar desconto)</h3>
            <label>CPF</label><input id="cpfResgatar" placeholder="000.000.000-00" inputmode="numeric" />
            <div class="row"><input id="valorResgatar" placeholder="Valor do resgate (R$)" inputmode="numeric" /></div>
            <div class="actions"><button id="btnResgatar" class="btn btn-primary" onclick="resgatar()">Resgatar</button><span id="outResgate" class="out"></span></div>
          </div>

          <!-- BOAS PRÁTICAS -->
          <div class="card">
            <h3>Boas práticas</h3>
            <ul class="muted" style="margin:6px 0 0 18px; line-height:1.6">
              <li>Peça o CPF do cliente no início da compra.</li>
              <li>Confirme o valor antes de lançar ou resgatar.</li>
              <li>Resgates devem ser lançados como <b>desconto</b> no seu PDV.</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- TAB: DASHBOARD -->
      <div id="tabDashboard" class="tab-content" style="display:none">
        <div class="card card-full">
          <h3>Visão Geral</h3>
          <div id="dashLoading" class="loading">Carregando dados...</div>
          <div id="dashContent" style="display:none">
            <h4>Hoje</h4>
            <div class="stats">
              <div class="stat">
                <div class="stat-label">Transações</div>
                <div class="stat-value" id="dashHojeTransacoes">0</div>
              </div>
              <div class="stat">
                <div class="stat-label">Clientes Únicos</div>
                <div class="stat-value" id="dashHojeClientes">0</div>
              </div>
              <div class="stat">
                <div class="stat-label">Desconto Gerado</div>
                <div class="stat-value" id="dashHojeCredito">R$ 0,00</div>
              </div>
              <div class="stat">
                <div class="stat-label">Desconto Usado</div>
                <div class="stat-value" id="dashHojeResgate">R$ 0,00</div>
              </div>
            </div>

            <h4 style="margin-top:24px">Este Mês</h4>
            <div class="stats">
              <div class="stat">
                <div class="stat-label">Transações</div>
                <div class="stat-value" id="dashMesTransacoes">0</div>
              </div>
              <div class="stat">
                <div class="stat-label">Clientes Únicos</div>
                <div class="stat-value" id="dashMesClientes">0</div>
              </div>
              <div class="stat">
                <div class="stat-label">Desconto Gerado</div>
                <div class="stat-value" id="dashMesCredito">R$ 0,00</div>
              </div>
              <div class="stat">
                <div class="stat-label">Desconto Usado</div>
                <div class="stat-value" id="dashMesResgate">R$ 0,00</div>
              </div>
              <div class="stat">
                <div class="stat-label">Saldo Pendente</div>
                <div class="stat-value" id="dashMesPendente">R$ 0,00</div>
                <div class="stat-sub">A resgatar</div>
              </div>
              <div class="stat">
                <div class="stat-label">Total Clientes</div>
                <div class="stat-value" id="dashTotalClientes">0</div>
                <div class="stat-sub">Cadastrados</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- TAB: HISTÓRICO -->
      <div id="tabHistorico" class="tab-content" style="display:none">
        <div class="card card-full">
          <h3>Histórico de Transações</h3>
          <label>Buscar por CPF</label>
          <input id="cpfHistorico" placeholder="Digite CPF para buscar" inputmode="numeric" />
          <button class="btn btn-ghost" style="margin-top:8px" onclick="buscarHistorico()">Buscar Histórico</button>
          
          <div id="histLoading" class="loading" style="display:none">Carregando...</div>
          <div id="histContent" style="display:none">
            <div style="margin:16px 0; padding:12px; background:#0b221e; border-radius:12px">
              <div style="font-size:14px; color:var(--subtle)">Cliente: <span id="histNome" style="color:var(--text); font-weight:600"></span></div>
              <div style="font-size:14px; color:var(--subtle); margin-top:4px">CPF: <span id="histCpf" style="color:var(--gold)"></span></div>
              <div style="font-size:18px; font-weight:700; color:var(--gold); margin-top:8px">Saldo: R$ <span id="histSaldo">0,00</span></div>
            </div>
            
            <div class="table-wrap">
              <table id="histTable">
                <thead>
                  <tr>
                    <th>Data</th>
                    <th>Tipo</th>
                    <th>Valor</th>
                    <th>Compra</th>
                    <th>Operador</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
          <div id="histEmpty" style="display:none; text-align:center; padding:20px; color:var(--subtle)">
            Digite um CPF para ver o histórico
          </div>
        </div>
      </div>

      <!-- TAB: CLIENTES -->
      <div id="tabClientes" class="tab-content" style="display:none">
        <div class="card card-full">
          <h3>Clientes com Saldo</h3>
          <label>Buscar cliente</label>
          <input id="buscaCliente" placeholder="Digite CPF ou nome (mín. 3 caracteres)" />
          <div id="searchResults" class="search-results" style="display:none"></div>
          
          <button class="btn btn-ghost" style="margin-top:12px" onclick="carregarTopClientes()">Ver TOP 20 com Maior Saldo</button>
          
          <div id="clientesLoading" class="loading" style="display:none">Carregando...</div>
          <div id="clientesContent" style="display:none">
            <div class="table-wrap">
              <table id="clientesTable">
                <thead>
                  <tr>
                    <th>CPF</th>
                    <th>Nome</th>
                    <th>Telefone</th>
                    <th>Saldo</th>
                    <th>Último uso</th>
                    <th>Ações</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- MODAL -->
    <div id="modalBackdrop" class="modal-backdrop">
      <div class="modal">
        <h3 id="modalTitle">Confirmar ação</h3>
        <p id="modalDesc"></p>
        <div class="row-end"><button class="btn btn-ghost" onclick="closeModal()">Cancelar</button><button id="modalConfirmBtn" class="btn btn-primary">Confirmar</button></div>
      </div>
    </div>

    <!-- TOASTS -->
    <div class="toast" id="toast"></div>

    <script>
      // ======== Estado / Helpers ========
      let TOKEN = null, CURRENT_USER = null;
      let currentTab = 'operacoes';
      const $ = (id)=>document.getElementById(id);
      const fmtBR = (n)=> Number(n||0).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2});
      const onlyDigits = (s)=> String(s||'').replace(/\D/g,'');
      const isVisible = (node)=> !!node && node.style.display !== 'none';

      function clearOutputs(except){
        if(except!=='saldo')   $('outSaldo').textContent   = '';
        if(except!=='compra')  $('outCompra').textContent  = '';
        if(except!=='resgate') $('outResgate').textContent = '';
      }

      // CPF máscara
      function cpfMask(v){
        const d = onlyDigits(v).slice(0,11);
        return d.replace(/^(\d{3})(\d)/,"$1.$2")
                .replace(/^(\d{3})\.(\d{3})(\d)/,"$1.$2.$3")
                .replace(/\.(\d{3})(\d)/,".$1-$2");
      }
      function attachCpfMask(id){ const el = $(id); el.addEventListener('input', ()=>{ el.value = cpfMask(el.value); }); }

      // Moeda máscara R$
      function moneyMask(el){
        let d = el.value.replace(/\D/g,'');
        if (d.length === 0){ el.value=''; return; }
        if (d.length === 1) d = '0' + d;
        const int = d.slice(0, -2).replace(/^0+(?=\d)/,'');
        const dec = d.slice(-2);
        const intFmt = int.replace(/\B(?=(\d{3})+(?!\d))/g,'.') || '0';
        el.value = `${intFmt},${dec}`;
      }
      function attachMoneyMask(id){ const el = $(id); el.addEventListener('input', ()=> moneyMask(el)); }
      function parseMoney(v){ if(!v) return 0; return parseFloat(v.replace(/\./g,'').replace(',','.')) || 0; }

      // Toasts
      function toast(text, ok=true){
        const box = $('toast'); const t = document.createElement('div');
        t.className = 't ' + (ok ? 'ok' : 'err'); t.textContent = text; box.appendChild(t);
        setTimeout(()=>{ t.style.opacity='0'; t.style.transform='translateY(6px)'; }, 2800);
        setTimeout(()=>{ try{ box.removeChild(t); }catch(_){} }, 3400);
      }

      // Views
      function showLogin(){ $('loginView').style.display='block'; $('changeView').style.display='none'; $('appView').style.display='none'; $('who').textContent='—'; }
      function showChange(){ $('loginView').style.display='none'; $('changeView').style.display='block'; $('appView').style.display='none'; }
      function showApp(){ $('loginView').style.display='none'; $('changeView').style.display='none'; $('appView').style.display='block'; }

      // Tabs
      function switchTab(tab){
        currentTab = tab;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(tc => tc.style.display = 'none');
        
        if (tab === 'operacoes') {
          document.querySelectorAll('.tab')[0].classList.add('active');
          $('tabOperacoes').style.display = 'block';
        } else if (tab === 'dashboard') {
          document.querySelectorAll('.tab')[1].classList.add('active');
          $('tabDashboard').style.display = 'block';
          carregarDashboard();
        } else if (tab === 'historico') {
          document.querySelectorAll('.tab')[2].classList.add('active');
          $('tabHistorico').style.display = 'block';
          $('histEmpty').style.display = 'block';
          // Enter no campo CPF dispara busca
          const el = $('cpfHistorico');
          if (!el._enterBound){
            el._enterBound = true;
            el.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); buscarHistorico(); } });
          }
        } else if (tab === 'clientes') {
          document.querySelectorAll('.tab')[3].classList.add('active');
          $('tabClientes').style.display = 'block';
          // carrega automaticamente o TOP 20
          carregarTopClientes();
        }
      }

      // Helpers de sessão no front
      function isSessionError(err){
        const s = (err && (err.msg || err.message || err.toString())) ? String(err.msg || err.message || err).toLowerCase() : '';
        return s.includes('sessão inválida') || s.includes('expirada') || s.includes('invalid session');
      }
      function forceRelog(msg){
        try{ localStorage.removeItem('cb_token'); localStorage.removeItem('cb_user'); }catch(_){}
        TOKEN = null; CURRENT_USER = null;
        showLogin();
        toast(msg || 'Sua sessão expirou. Faça login novamente.', false);
      }

      // Session restore
      (function init(){
        ['cpfSaldo','cpfCompra','cpfResgatar','cpfHistorico'].forEach(attachCpfMask);
        ['valorCompra','valorResgatar'].forEach(attachMoneyMask);
        
        // Busca de clientes em tempo real
        $('buscaCliente').addEventListener('input', debounce(buscarClientesAoDigitar, 300));
        
        const t = localStorage.getItem('cb_token'), u = localStorage.getItem('cb_user');
        if (t && u){ TOKEN=t; CURRENT_USER=u; $('who').textContent='Operador: '+CURRENT_USER; showApp(); }
        else { showLogin(); }
      })();

      // Debounce helper
      function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      }

      // ======== Auth ========
      function login(){
        const username = $('username').value.trim(), password = $('password').value;
        $('loginMsg').textContent='';
        google.script.run
          .withSuccessHandler(r=>{
            if(!r.ok){ $('loginMsg').textContent = r.msg || 'Falha no login'; toast(r.msg || 'Falha no login', false); return; }
            TOKEN=r.token; CURRENT_USER=r.username;
            localStorage.setItem('cb_token',TOKEN); localStorage.setItem('cb_user',CURRENT_USER);
            $('who').textContent='Operador: '+CURRENT_USER;
            if(r.must_change){ showChange(); } else { showApp(); toast('Login realizado'); }
          })
          .withFailureHandler(e=>{ $('loginMsg').textContent='Erro: '+e; toast('Erro no login', false); })
          .apiLogin({username, password});
      }
      
      function changePass(){
        const a=$('newPass').value, b=$('newPass2').value; $('changeMsg').textContent='';
        if(a.length<8){ $('changeMsg').textContent='Senha mínima de 8 caracteres.'; toast('Senha muito curta', false); return; }
        if(a!==b){ $('changeMsg').textContent='As senhas não conferem.'; toast('As senhas não conferem', false); return; }
        google.script.run
          .withSuccessHandler(r=>{
            if(!r.ok){ $('changeMsg').textContent=r.msg||'Erro ao salvar'; toast('Erro ao salvar senha', false); return; }
            showApp(); toast('Senha atualizada');
          })
          .withFailureHandler(e=>{ $('changeMsg').textContent='Erro: '+e; toast('Erro ao salvar senha', false); })
          .apiChangePassword({ username: CURRENT_USER, newPassword: a, token: TOKEN });
      }
      
      function logout(){
        google.script.run.withSuccessHandler(()=>{
          localStorage.removeItem('cb_token'); localStorage.removeItem('cb_user');
          TOKEN=null; CURRENT_USER=null; showLogin(); toast('Sessão encerrada');
        }).apiLogout({ token: TOKEN });
      }

      // ======== Modal ========
      let modalConfirmCb=null;
      function openModal(title, htmlDesc, onConfirm){
        $('modalTitle').textContent=title; $('modalDesc').innerHTML=htmlDesc;
        $('modalBackdrop').style.display='grid'; modalConfirmCb=onConfirm;
      }
      function closeModal(){ $('modalBackdrop').style.display='none'; modalConfirmCb=null; }
      document.getElementById('modalConfirmBtn').addEventListener('click', ()=>{
        if(modalConfirmCb){ const fn=modalConfirmCb; closeModal(); fn(); }
      });

      // ======== Ações ========
      function getSaldo(){
        const cpf = $('cpfSaldo').value;
        clearOutputs('saldo');
        $('outSaldo').textContent='';
        google.script.run
          .withSuccessHandler(r=>{
            if(!r.ok){
              if (isSessionError(r)) { forceRelog(r.msg); return; }
              $('outSaldo').textContent = r.msg || 'Falha'; toast(r.msg || 'Falha', false); return;
            }
            $('outSaldo').textContent = `Saldo de desconto: R$ ${fmtBR(r.saldo)}`;
          })
          .withFailureHandler(e=>{
            if (isSessionError(e)) { forceRelog('Sua sessão expirou.'); return; }
            $('outSaldo').textContent='Erro: '+e; toast('Erro ao consultar', false);
          })
          .apiGetSaldo({ token: TOKEN, cpf });
      }

      function lancar(){
        const cpf=$('cpfCompra').value, valor=parseMoney($('valorCompra').value), notaRef=$('notaRef').value;
        if(!cpf || !valor || valor<=0){ $('outCompra').textContent='Preencha CPF e um valor válido.'; toast('Campos inválidos', false); return; }

        openModal('Confirmar lançamento',
          `<p><b>CPF:</b> ${cpf}</p><p><b>Valor da compra:</b> R$ ${fmtBR(valor)}</p><p class="muted">Isso vai gerar <b>desconto</b> conforme as regras da loja.</p>`,
          function(){
            clearOutputs('compra');
            const btn=$('btnLancar'); btn.disabled=true; $('outCompra').textContent='Processando…';
            const payload={ token:TOKEN, cpf, valorCompra: valor, notaRef };
            google.script.run
              .withSuccessHandler(r=>{
                btn.disabled=false;
                if(!r.ok){
                  if (isSessionError(r)) { forceRelog(r.msg); return; }
                  $('outCompra').textContent=r.msg||'Falha ao lançar'; toast(r.msg||'Falha ao lançar', false); return;
                }
                $('outCompra').textContent=`Desconto gerado: R$ ${fmtBR(r.credito)} | Saldo de desconto: R$ ${fmtBR(r.saldoAtual)}`;
                $('valorCompra').value=''; $('notaRef').value='';
                toast('Lançamento registrado');
                if(r.limited){ toast(`Desconto limitado — gerado R$ ${fmtBR(r.credito)}.`, true); }
              })
              .withFailureHandler(e=>{
                btn.disabled=false;
                if (isSessionError(e)) { forceRelog('Sua sessão expirou.'); return; }
                $('outCompra').textContent='Erro: '+e; toast('Erro ao lançar', false);
              })
              .apiLancarCompra(payload);
          }
        );
      }

      function resgatar(){
        const cpf=$('cpfResgatar').value, valor=parseMoney($('valorResgatar').value);
        if(!cpf || !valor || valor<=0){ $('outResgate').textContent='Preencha CPF e um valor válido.'; toast('Campos inválidos', false); return; }

        openModal('Confirmar abatimento', `<p><b>CPF:</b> ${cpf}</p><p><b>Valor a abater:</b> R$ ${fmtBR(valor)}</p>`,
          function(){
            clearOutputs('resgate');
            const btn=$('btnResgatar'); btn.disabled=true; $('outResgate').textContent='Processando…';
            const payload={ token:TOKEN, cpf, valorResgate: valor };
            google.script.run
              .withSuccessHandler(r=>{
                btn.disabled=false;
                if(!r.ok){
                  if (isSessionError(r)) { forceRelog(r.msg); return; }
                  $('outResgate').textContent=r.msg||'Falha no resgate'; toast(r.msg||'Falha no resgate', false); return;
                }
                $('outResgate').textContent=`Desconto abatido: R$ ${fmtBR(r.resgatado)} | Saldo de desconto: R$ ${fmtBR(r.saldoAtual)}`;
                $('valorResgatar').value='';
                toast('Desconto abatido');
              })
              .withFailureHandler(e=>{
                btn.disabled=false;
                if (isSessionError(e)) { forceRelog('Sua sessão expirou.'); return; }
                $('outResgate').textContent='Erro: '+e; toast('Erro no resgate', false);
              })
              .apiResgatar(payload);
          }
        );
      }

      // ======== Dashboard ========
      function carregarDashboard(){
        $('dashLoading').style.display='block';
        $('dashContent').style.display='none';
        
        google.script.run
          .withSuccessHandler(r=>{
            $('dashLoading').style.display='none';
            if(!r.ok){
              if (isSessionError(r)) { forceRelog(r.msg); return; }
              toast('Erro ao carregar dashboard', false); return;
            }
            
            $('dashHojeTransacoes').textContent = r.hoje.transacoes;
            $('dashHojeClientes').textContent = r.hoje.clientesUnicos;
            $('dashHojeCredito').textContent = 'R$ ' + fmtBR(r.hoje.creditoGerado);
            $('dashHojeResgate').textContent = 'R$ ' + fmtBR(r.hoje.resgateFeito);
            
            $('dashMesTransacoes').textContent = r.mes.transacoes;
            $('dashMesClientes').textContent = r.mes.clientesUnicos;
            $('dashMesCredito').textContent = 'R$ ' + fmtBR(r.mes.creditoGerado);
            $('dashMesResgate').textContent = 'R$ ' + fmtBR(r.mes.resgateFeito);
            $('dashMesPendente').textContent = 'R$ ' + fmtBR(r.mes.saldoPendente);
            $('dashTotalClientes').textContent = r.totalClientes;
            
            $('dashContent').style.display='block';
          })
          .withFailureHandler(e=>{
            $('dashLoading').style.display='none';
            if (isSessionError(e)) { forceRelog(); return; }
            toast('Erro ao carregar dashboard', false);
          })
          .apiGetDashboard({ token: TOKEN });
      }

      // ======== Histórico ========
      function buscarHistorico(){
        const cpf = onlyDigits($('cpfHistorico').value);
        if(!cpf || cpf.length < 11){ toast('Digite um CPF completo', false); return; }
        
        $('histLoading').style.display='block';
        $('histContent').style.display='none';
        $('histEmpty').style.display='none';
        
        google.script.run
          .withSuccessHandler(r=>{
            $('histLoading').style.display='none';
            if(!r.ok){
              if (isSessionError(r)) { forceRelog(r.msg); return; }
              toast(r.msg || 'Erro ao buscar histórico', false); 
              $('histEmpty').style.display='block';
              return;
            }
            
            $('histNome').textContent = r.nome || 'Sem nome';
            $('histCpf').textContent = cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
            $('histSaldo').textContent = fmtBR(r.saldoAtual);
            
            const tbody = $('histTable').querySelector('tbody');
            tbody.innerHTML = '';
            
            if(r.historico.length === 0){
              tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:var(--subtle)">Nenhuma transação encontrada</td></tr>';
            } else {
              r.historico.forEach(tx => {
                const tr = document.createElement('tr');
                const data = new Date(tx.data);
                const dataFmt = data.toLocaleDateString('pt-BR') + ' ' + data.toLocaleTimeString('pt-BR', {hour:'2-digit',minute:'2-digit'});
                
                let badgeClass = 'badge-credit';
                if(tx.tipo === 'RESGATE') badgeClass = 'badge-resgate';
                if(tx.tipo === 'AJUSTE') badgeClass = 'badge-ajuste';
                
                const valorFmt = tx.valor >= 0 ? '+R$ ' + fmtBR(tx.valor) : '-R$ ' + fmtBR(Math.abs(tx.valor));
                const compraFmt = tx.valorCompra ? 'R$ ' + fmtBR(tx.valorCompra) : '-';
                
                tr.innerHTML = `
                  <td>${dataFmt}</td>
                  <td><span class="badge ${badgeClass}">${tx.tipo}</span></td>
                  <td style="font-weight:600">${valorFmt}</td>
                  <td>${compraFmt}</td>
                  <td>${tx.operador}</td>
                `;
                tbody.appendChild(tr);
              });
            }
            
            $('histContent').style.display='block';
          })
          .withFailureHandler(e=>{
            $('histLoading').style.display='none';
            if (isSessionError(e)) { forceRelog(); return; }
            toast('Erro ao buscar histórico', false);
            $('histEmpty').style.display='block';
          })
          .apiGetHistorico({ token: TOKEN, cpf });
      }

      // ======== Clientes ========
      function buscarClientesAoDigitar(){
        const termo = $('buscaCliente').value.trim();
        
        if(termo.length < 3){
          $('searchResults').style.display='none';
          $('clientesContent').style.display='none';
          return;
        }
        
        google.script.run
          .withSuccessHandler(r=>{
            if(!r.ok){
              if (isSessionError(r)) { forceRelog(r.msg); return; }
              return;
            }
            
            const results = $('searchResults');
            results.innerHTML = '';
            
            if(r.clientes.length === 0){
              results.innerHTML = '<div style="padding:10px; text-align:center; color:var(--subtle)">Nenhum cliente encontrado</div>';
              results.style.display='block';
              return;
            }
            
            r.clientes.forEach(cli => {
              const div = document.createElement('div');
              div.className = 'search-item';
              div.innerHTML = `
                <div class="search-cpf">${cli.cpf_formatado}</div>
                <div class="search-nome">${cli.nome}</div>
                <div class="search-saldo">Saldo: R$ ${fmtBR(cli.saldo)}</div>
              `;
              div.onclick = () => {
                $('cpfHistorico').value = cli.cpf_formatado;
                $('buscaCliente').value = '';
                $('searchResults').style.display='none';
                switchTab('historico');
                setTimeout(() => buscarHistorico(), 100);
              };
              results.appendChild(div);
            });
            
            results.style.display='block';
          })
          .withFailureHandler(e=>{
            if (isSessionError(e)) { forceRelog(); return; }
          })
          .apiBuscarClientes({ token: TOKEN, termo });
      }

      function carregarTopClientes(){
        $('clientesLoading').style.display='block';
        $('clientesContent').style.display='none';
        $('searchResults').style.display='none';
        
        google.script.run
          .withSuccessHandler(r=>{
            $('clientesLoading').style.display='none';
            const tbody = $('clientesTable').querySelector('tbody');
            tbody.innerHTML = '';
            
            if(!r || !r.ok){
              if (r && isSessionError(r)) { forceRelog(r.msg); return; }
              const msg = (r && r.msg) ? `Erro ao carregar clientes (${r.msg})` : 'Erro ao carregar clientes';
              tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:var(--subtle)">${msg}</td></tr>`;
              $('clientesContent').style.display='block';
              return;
            }

            if(!r.clientes || r.clientes.length === 0){
              tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:var(--subtle)">Nenhum cliente com saldo</td></tr>';
            } else {
              r.clientes.forEach(cli => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                  <td style="color:var(--gold); font-weight:600">${cli.cpf_formatado}</td>
                  <td>${cli.nome}</td>
                  <td>${cli.telefone || '-'}</td>
                  <td style="font-weight:700">R$ ${fmtBR(cli.saldo)}</td>
                  <td>${cli.ultimo_uso || '-'}</td>
                  <td>
                    <button class="btn btn-ghost btn-small" onclick="verHistoricoCliente('${cli.cpf_formatado}')">Ver histórico</button>
                  </td>
                `;
                tbody.appendChild(tr);
              });
            }
            $('clientesContent').style.display='block';
          })
          .withFailureHandler(e=>{
            $('clientesLoading').style.display='none';
            const tbody = $('clientesTable').querySelector('tbody');
            const msg = e && e.message ? `Erro ao carregar clientes (${e.message})` : 'Erro ao carregar clientes';
            tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:var(--subtle)">${msg}</td></tr>`;
            $('clientesContent').style.display='block';
            if (isSessionError(e)) { forceRelog(); return; }
          })
          .apiGetTopClientes({ token: TOKEN });
      }

      function verHistoricoCliente(cpf){
        $('cpfHistorico').value = cpf;
        $('buscaCliente').value = '';
        switchTab('historico');
        setTimeout(() => buscarHistorico(), 100);
      }
    </script>
  </body>
</html>
