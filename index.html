<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <title>Desconto da Casa</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root{
        --bg:#081d1a; --card:#0f2f2a; --muted:#16433c;
        --text:#eaf7f3; --subtle:#b9d6cd;
        --gold:#d4af37; --gold-2:#b9952f;
        --shadow: 0 10px 30px rgba(0,0,0,.35); --radius:16px;
      }
      *{box-sizing:border-box} html,body{height:100%}
      body{margin:0; background:linear-gradient(180deg,#071815 0%,#0a2420 100%); color:var(--text); font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,Helvetica,sans-serif}

      .top{position:sticky; top:0; z-index:50; background:linear-gradient(90deg,#0a2621 0%,#0c302a 50%,#0a2621 100%); border-bottom:1px solid rgba(212,175,55,.18); box-shadow:var(--shadow)}
      .top-inner{max-width:1100px; margin:0 auto; padding:16px 16px; display:flex; align-items:center; gap:16px}

      .brand{display:flex; align-items:center; gap:12px; font-weight:700; letter-spacing:.3px}
      .ddc-logo{width:64px; height:64px; border-radius:14px; display:block; object-fit:cover}
      .wordmark{font-size:22px; color:var(--text)}
      .wordmark strong{color:var(--gold); font-weight:900; letter-spacing:.5px}

      .userbox{margin-left:auto; display:flex; align-items:center; gap:10px; color:var(--subtle)}
      .btn{appearance:none; border:none; cursor:pointer; border-radius:12px; padding:10px 14px; font-weight:600; transition:all .18s ease}
      .btn-primary{color:#111; background:linear-gradient(180deg, var(--gold) 0%, #c6a232 100%); box-shadow:0 6px 18px rgba(212,175,55,.25)}
      .btn-primary:hover{background:linear-gradient(180deg, var(--gold-2) 0%, #a88324 100%)}
      .btn-ghost{color:var(--gold); background:transparent; border:1px solid rgba(212,175,55,.45)}
      .btn-ghost:hover{background:rgba(212,175,55,.08)}
      .btn-small{padding:6px 10px; font-size:13px}
      
      .wrap{max-width:1100px; margin:24px auto; padding:0 16px}
      .grid{display:grid; gap:16px; grid-template-columns:1fr}
      @media(min-width:880px){ .grid{grid-template-columns:repeat(2,1fr)} }
      .card{background:linear-gradient(180deg, var(--card), #0c2723); border:1px solid rgba(212,175,55,.12); border-radius:var(--radius); padding:18px; box-shadow:var(--shadow)}
      .card-full{grid-column: 1 / -1}
      
      h1{margin:0 0 8px; font-size:22px} 
      h2,h3{margin:0 0 12px}
      h4{margin:8px 0 6px; font-size:14px; color:var(--subtle)}
      
      label{display:block; margin:10px 0 6px; color:var(--subtle); font-size:13px}
      .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
      input{flex:1 1 auto; min-width:180px; padding:12px 12px; border-radius:12px; color:var(--text); background:#0b221e; border:1px solid var(--muted); outline:none; transition:all .18s ease}
      input::placeholder{color:#7fa69c} 
      input:focus{border-color:var(--gold); box-shadow:0 0 0 3px rgba(212,175,55,.15)}
      
      .actions{display:flex; gap:10px; align-items:center; margin-top:10px}
      .muted{color:var(--subtle); font-size:13px} 
      .out{margin-top:10px; font-weight:600}
      .stack{max-width:520px; margin:32px auto; display:flex; flex-direction:column; gap:16px}

      /* Tabs */
      .tabs{display:flex; gap:8px; margin-bottom:16px; border-bottom:1px solid rgba(212,175,55,.12); overflow-x:auto}
      .tab{padding:12px 18px; cursor:pointer; border-bottom:2px solid transparent; transition:all .18s; white-space:nowrap; color:var(--subtle); font-weight:600}
      .tab:hover{color:var(--text); background:rgba(212,175,55,.05)}
      .tab.active{color:var(--gold); border-bottom-color:var(--gold)}

      /* Stats */
      .stats{display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:12px; margin-bottom:16px}
      .stat{background:#0b221e; padding:14px; border-radius:12px; border:1px solid var(--muted)}
      .stat-label{font-size:12px; color:var(--subtle); margin-bottom:4px}
      .stat-value{font-size:24px; font-weight:700; color:var(--gold)}
      .stat-sub{font-size:13px; color:var(--subtle); margin-top:2px}

      /* Table */
      .table-wrap{overflow-x:auto; margin-top:12px}
      table{width:100%; border-collapse:collapse}
      th{text-align:left; padding:10px 8px; font-size:12px; color:var(--subtle); border-bottom:1px solid var(--muted)}
      td{padding:10px 8px; border-bottom:1px solid rgba(212,175,55,.06); font-size:14px}
      tr:hover{background:rgba(212,175,55,.03)}
      .badge{display:inline-block; padding:4px 8px; border-radius:6px; font-size:11px; font-weight:600}
      .badge-credit{background:rgba(94,221,168,.15); color:#5eddaa}
      .badge-resgate{background:rgba(255,92,92,.15); color:#ff5c5c}
      .badge-ajuste{background:rgba(100,150,255,.15); color:#6496ff}

      /* Clientes */
      .client-card{display:flex; flex-direction:column; gap:18px}
      .client-header{display:flex; flex-wrap:wrap; justify-content:space-between; gap:14px; align-items:flex-start}
      .client-header h3{margin:0; font-size:20px}
      .client-status{font-size:13px; color:var(--subtle)}
      .client-toolbar{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
      .client-toolbar input{max-width:280px}
      .client-metrics{display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:12px}
      .metric{background:#0b221e; padding:12px 14px; border-radius:12px; border:1px solid var(--muted); display:flex; flex-direction:column; gap:4px}
      .metric-label{font-size:12px; color:var(--subtle); letter-spacing:.4px; text-transform:uppercase}
      .metric-value{font-size:22px; font-weight:700; color:var(--gold)}
      .metric-sub{font-size:12px; color:var(--subtle)}
      .toggle{display:flex; align-items:center; gap:8px; font-size:13px; color:var(--subtle)}
      .toggle input{width:16px; height:16px; accent-color:var(--gold)}

      @media(max-width:540px){
        .client-toolbar input{width:100%; flex:1 1 100%}
        .metric-value{font-size:20px}
      }

      /* Search results */
      .search-results{margin-top:8px; max-height:300px; overflow-y:auto; background:#0b221e; border:1px solid var(--muted); border-radius:12px}
      .search-item{padding:10px 12px; cursor:pointer; border-bottom:1px solid rgba(212,175,55,.06); transition:all .15s}
      .search-item:hover{background:rgba(212,175,55,.08)}
      .search-item:last-child{border-bottom:none}
      .search-cpf{font-weight:600; color:var(--gold)}
      .search-nome{font-size:14px; color:var(--text)}
      .search-saldo{font-size:12px; color:var(--subtle)}

      /* Modal */
      .modal-backdrop{position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; place-items:center; z-index:100}
      .modal{width:min(480px,92vw); background:#0e2a25; border-radius:18px; padding:18px; border:1px solid rgba(212,175,55,.22); box-shadow:var(--shadow)}
      .modal h3{margin:0 0 10px} 
      .modal p{margin:8px 0; color:var(--subtle)} 
      .modal .row-end{display:flex; justify-content:flex-end; gap:10px; margin-top:14px}

      /* Toasts */
      .toast{position:fixed; right:18px; bottom:18px; z-index:120; display:flex; flex-direction:column; gap:10px}
      .toast .t{background:#0f2f2a; border:1px solid rgba(212,175,55,.22); color:var(--text); padding:12px 14px; border-radius:12px; box-shadow:var(--shadow); min-width:240px}
      .t.ok{border-color:rgba(94,221,168,.35)} 
      .t.err{border-color:rgba(255,92,92,.45)}

      /* Loading */
      .loading{text-align:center; padding:20px; color:var(--subtle)}

      @media (max-width:520px){
        .ddc-logo{width:44px; height:44px; border-radius:12px}
        .wordmark{font-size:18px}
        .top-inner{gap:12px; padding:12px 14px}
        .stats{grid-template-columns:1fr}
      }
    </style>
  </head>
  <body>
    <div class="top">
      <div class="top-inner">
        <div class="brand">
          <img class="ddc-logo"
               src="https://lh3.googleusercontent.com/d/1vmsGM2STkfh0u-hgrKsZDw3zhTKJcEhf=w512"
               alt="Desconto da Casa" />
          <span class="wordmark"><strong>DESCONTO</strong> da Casa</span>
        </div>
        <div class="userbox">
          <span id="who">—</span>
          <button class="btn btn-ghost" onclick="logout()">Sair</button>
        </div>
      </div>
    </div>

    <!-- LOGIN -->
    <div id="loginView" class="wrap stack">
      <div class="card">
        <h1>Entrar</h1>
        <label>Usuário</label><input id="username" placeholder="ex: lojista1" />
        <label>Senha</label><input id="password" type="password" placeholder="Sua senha" />
        <div class="actions"><button class="btn btn-primary" onclick="login()">Entrar</button><span id="loginMsg" class="muted"></span></div>
      </div>
    </div>

    <!-- TROCA DE SENHA -->
    <div id="changeView" class="wrap stack" style="display:none">
      <div class="card">
        <h1>Defina sua nova senha</h1>
        <label>Nova senha</label><input id="newPass" type="password" placeholder="Mínimo 8 caracteres" />
        <label>Confirme a nova senha</label><input id="newPass2" type="password" placeholder="Repita a senha" />
        <div class="actions"><button class="btn btn-primary" onclick="changePass()">Salvar nova senha</button><span id="changeMsg" class="muted"></span></div>
      </div>
    </div>

    <!-- APP -->
    <div id="appView" class="wrap" style="display:none">
      <!-- Tabs -->
      <div class="tabs">
        <div class="tab active" data-tab="operacoes" onclick="switchTab('operacoes')">Operações</div>
        <div class="tab" data-tab="dashboard" onclick="switchTab('dashboard')">Dashboard</div>
        <div class="tab" data-tab="clientes" onclick="switchTab('clientes')">Clientes</div>
        <div class="tab" data-tab="historico" onclick="switchTab('historico')">Histórico</div>
      </div>

      <!-- TAB: OPERAÇÕES -->
      <div id="tabOperacoes" class="tab-content">
        <div class="grid">
          <!-- CONSULTAR -->
          <div class="card">
            <h3>Consultar saldo</h3>
            <label>CPF</label>
            <div class="row"><input id="cpfSaldo" placeholder="000.000.000-00" inputmode="numeric" /><button class="btn btn-ghost" onclick="getSaldo()">Ver saldo</button></div>
            <div id="outSaldo" class="out"></div>
          </div>

          <!-- LANÇAR -->
          <div class="card">
            <h3>Lançar compra (gerar desconto)</h3>
            <label>CPF</label><input id="cpfCompra" placeholder="000.000.000-00" inputmode="numeric" />
            <div class="row">
              <input id="valorCompra" placeholder="Valor da compra (R$)" inputmode="numeric" />
              <input id="notaRef" placeholder="Nota Ref (opcional)" />
            </div>
            <div class="actions"><button id="btnLancar" class="btn btn-primary" onclick="lancar()">Lançar</button><span id="outCompra" class="out"></span></div>
          </div>

          <!-- RESGATAR -->
          <div class="card">
            <h3>Resgatar saldo (dar desconto)</h3>
            <label>CPF</label><input id="cpfResgatar" placeholder="000.000.000-00" inputmode="numeric" />
            <div class="row"><input id="valorResgatar" placeholder="Valor do resgate (R$)" inputmode="numeric" /></div>
            <div class="actions"><button id="btnResgatar" class="btn btn-primary" onclick="resgatar()">Resgatar</button><span id="outResgate" class="out"></span></div>
          </div>

          <!-- BOAS PRÁTICAS -->
          <div class="card">
            <h3>Boas práticas</h3>
            <ul class="muted" style="margin:6px 0 0 18px; line-height:1.6">
              <li>Peça o CPF do cliente no início da compra.</li>
              <li>Confirme o valor antes de lançar ou resgatar.</li>
              <li>Resgates devem ser lançados como <b>desconto</b> no seu PDV.</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- TAB: DASHBOARD -->
      <div id="tabDashboard" class="tab-content" style="display:none">
        <div class="card card-full">
          <h3>Visão Geral</h3>
          <div id="dashLoading" class="loading">Carregando dados...</div>
          <div id="dashContent" style="display:none">
            <h4>Hoje</h4>
            <div class="stats">
              <div class="stat">
                <div class="stat-label">Transações</div>
                <div class="stat-value" id="dashHojeTransacoes">0</div>
              </div>
              <div class="stat">
                <div class="stat-label">Clientes Únicos</div>
                <div class="stat-value" id="dashHojeClientes">0</div>
              </div>
              <div class="stat">
                <div class="stat-label">Desconto Gerado</div>
                <div class="stat-value" id="dashHojeCredito">R$ 0,00</div>
              </div>
              <div class="stat">
                <div class="stat-label">Desconto Usado</div>
                <div class="stat-value" id="dashHojeResgate">R$ 0,00</div>
              </div>
            </div>

            <h4 style="margin-top:24px">Este Mês</h4>
            <div class="stats">
              <div class="stat">
                <div class="stat-label">Transações</div>
                <div class="stat-value" id="dashMesTransacoes">0</div>
              </div>
              <div class="stat">
                <div class="stat-label">Clientes Únicos</div>
                <div class="stat-value" id="dashMesClientes">0</div>
              </div>
              <div class="stat">
                <div class="stat-label">Desconto Gerado</div>
                <div class="stat-value" id="dashMesCredito">R$ 0,00</div>
              </div>
              <div class="stat">
                <div class="stat-label">Desconto Usado</div>
                <div class="stat-value" id="dashMesResgate">R$ 0,00</div>
              </div>
              <div class="stat">
                <div class="stat-label">Saldo Pendente</div>
                <div class="stat-value" id="dashMesPendente">R$ 0,00</div>
                <div class="stat-sub">A resgatar</div>
              </div>
              <div class="stat">
                <div class="stat-label">Total Clientes</div>
                <div class="stat-value" id="dashTotalClientes">0</div>
                <div class="stat-sub">Cadastrados</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- TAB: CLIENTES -->
      <div id="tabClientes" class="tab-content" style="display:none">
        <div class="card card-full client-card">
          <div class="client-header">
            <div>
              <h3>Base de Clientes</h3>
              <p class="muted">Visualize em tempo real os clientes cadastrados na aba <strong>Customers</strong> da planilha.</p>
            </div>
            <div class="actions" style="margin:0">
              <button id="btnRelatorioClientes" class="btn btn-primary" onclick="gerarRelatorioClientes()">Atualizar lista</button>
            </div>
          </div>
          <div id="clientesStatus" class="client-status">Clique em "Atualizar lista" para carregar os clientes.</div>
          <div id="clientesMetrics" class="client-metrics" style="display:none">
            <div class="metric">
              <span class="metric-label">Clientes cadastrados</span>
              <span class="metric-value" id="clientesMetricTotal">0</span>
              <span class="metric-sub">Total na planilha</span>
            </div>
            <div class="metric">
              <span class="metric-label">Clientes com saldo</span>
              <span class="metric-value" id="clientesMetricAtivos">0</span>
              <span class="metric-sub">Saldo maior que zero</span>
            </div>
            <div class="metric">
              <span class="metric-label">Saldo acumulado</span>
              <span class="metric-value" id="clientesMetricSaldo">R$ 0,00</span>
              <span class="metric-sub">Somatório dos saldos</span>
            </div>
            <div class="metric">
              <span class="metric-label">Maior saldo</span>
              <span class="metric-value" id="clientesMetricMaior">R$ 0,00</span>
              <span class="metric-sub">Cliente no topo da lista</span>
            </div>
          </div>
          <div id="clientesToolbar" class="client-toolbar" style="display:none">
            <input id="clientesFiltro" placeholder="Filtrar por nome ou CPF" />
            <label class="toggle">
              <input type="checkbox" id="clientesSomenteSaldo" />
              <span>Mostrar apenas clientes com saldo</span>
            </label>
          </div>
          <div id="clientesEmpty" class="muted" style="display:none">Nenhum cliente encontrado.</div>
          <div id="clientesTableWrap" class="table-wrap" style="display:none">
            <table>
              <thead>
                <tr>
                  <th>#</th>
                  <th>CPF</th>
                  <th>Nome</th>
                  <th>Telefone</th>
                  <th>Saldo atual</th>
                  <th>Último uso</th>
                  <th>Cadastro</th>
                </tr>
              </thead>
              <tbody id="clientesTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- TAB: HISTÓRICO -->
      <div id="tabHistorico" class="tab-content" style="display:none">
        <div class="card card-full client-card">
          <div class="client-header">
            <div>
              <h3>Histórico de movimentações</h3>
              <p class="muted">Consulte compras, descontos gerados e resgates por CPF.</p>
            </div>
          </div>
          <div class="client-toolbar" style="margin-top:0">
            <input id="historicoCpf" placeholder="Informe o CPF" inputmode="numeric" />
            <button id="btnHistorico" class="btn btn-primary" onclick="buscarHistorico()">Buscar histórico</button>
          </div>
          <div id="historicoStatus" class="client-status">Informe o CPF do cliente e clique em "Buscar histórico".</div>
          <div id="historicoResumo" class="client-metrics" style="display:none">
            <div class="metric">
              <span class="metric-label">Cliente</span>
              <span class="metric-value" id="historicoMetricNome">-</span>
              <span class="metric-sub" id="historicoMetricCpf">CPF não informado</span>
            </div>
            <div class="metric">
              <span class="metric-label">Saldo atual</span>
              <span class="metric-value" id="historicoMetricSaldo">R$ 0,00</span>
              <span class="metric-sub">Saldo de descontos</span>
            </div>
            <div class="metric">
              <span class="metric-label">Total faturado</span>
              <span class="metric-value" id="historicoMetricFaturado">R$ 0,00</span>
              <span class="metric-sub">Compras lançadas</span>
            </div>
            <div class="metric">
              <span class="metric-label">Desconto gerado</span>
              <span class="metric-value" id="historicoMetricGerado">R$ 0,00</span>
              <span class="metric-sub">Cashback acumulado</span>
            </div>
            <div class="metric">
              <span class="metric-label">Desconto resgatado</span>
              <span class="metric-value" id="historicoMetricResgatado">R$ 0,00</span>
              <span class="metric-sub">Total abatido</span>
            </div>
            <div class="metric">
              <span class="metric-label">Movimentações</span>
              <span class="metric-value" id="historicoMetricMovimentos">0</span>
              <span class="metric-sub">Registros encontrados</span>
            </div>
          </div>
          <div id="historicoEmpty" class="muted" style="display:none">Nenhuma movimentação encontrada para este CPF.</div>
          <div id="historicoTableWrap" class="table-wrap" style="display:none">
            <table>
              <thead>
                <tr>
                  <th>Data</th>
                  <th>Tipo</th>
                  <th>Total da compra</th>
                  <th>Desconto / Valor</th>
                  <th>Operador</th>
                  <th>Nota</th>
                  <th>Ações</th>
                </tr>
              </thead>
              <tbody id="historicoTableBody"></tbody>
            </table>
          </div>
        </div>
        <div class="card card-full client-card" style="margin-top:16px">
          <div class="client-header">
            <div>
              <h3>Consulta por período</h3>
              <p class="muted">Liste transações de todos os CPFs por data.</p>
            </div>
          </div>
          <div class="client-toolbar" style="margin-top:0">
            <input id="historicoInicio" type="date" />
            <input id="historicoFim" type="date" />
            <button id="btnHistoricoPeriodo" class="btn btn-primary" onclick="buscarHistoricoPeriodo()">Buscar período</button>
          </div>
          <div id="historicoPeriodoStatus" class="client-status">Selecione um intervalo de datas e clique em "Buscar período".</div>
          <div id="historicoPeriodoResumo" class="client-metrics" style="display:none">
            <div class="metric">
              <span class="metric-label">Período</span>
              <span class="metric-value" id="historicoPeriodoIntervalo">-</span>
              <span class="metric-sub">Datas consideradas</span>
            </div>
            <div class="metric">
              <span class="metric-label">Movimentações</span>
              <span class="metric-value" id="historicoPeriodoMovimentos">0</span>
              <span class="metric-sub">Registros encontrados</span>
            </div>
            <div class="metric">
              <span class="metric-label">Crédito gerado</span>
              <span class="metric-value" id="historicoPeriodoCredito">R$ 0,00</span>
              <span class="metric-sub">Somatório positivo</span>
            </div>
            <div class="metric">
              <span class="metric-label">Resgate / Ajustes</span>
              <span class="metric-value" id="historicoPeriodoResgate">R$ 0,00</span>
              <span class="metric-sub">Resgates e ajustes negativos</span>
            </div>
            <div class="metric">
              <span class="metric-label">Líquido</span>
              <span class="metric-value" id="historicoPeriodoLiquido">R$ 0,00</span>
              <span class="metric-sub">Saldo do período</span>
            </div>
          </div>
          <div id="historicoPeriodoEmpty" class="muted" style="display:none">Nenhuma transação encontrada para o período selecionado.</div>
          <div id="historicoPeriodoTableWrap" class="table-wrap" style="display:none">
            <table>
              <thead>
                <tr>
                  <th>Data</th>
                  <th>CPF</th>
                  <th>Tipo</th>
                  <th>Total da compra</th>
                  <th>Desconto / Valor</th>
                  <th>Operador</th>
                  <th>Nota</th>
                  <th>Ações</th>
                </tr>
              </thead>
              <tbody id="historicoPeriodoTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>

    </div>

    <!-- MODAL -->
    <div id="modalBackdrop" class="modal-backdrop">
      <div class="modal">
        <h3 id="modalTitle">Confirmar ação</h3>
        <p id="modalDesc"></p>
        <div class="row-end"><button class="btn btn-ghost" onclick="closeModal()">Cancelar</button><button id="modalConfirmBtn" class="btn btn-primary">Confirmar</button></div>
      </div>
    </div>

    <!-- TOASTS -->
    <div class="toast" id="toast"></div>

    <script>
      // ======== Estado / Helpers ========
      let TOKEN = null, CURRENT_USER = null;
      let currentTab = 'operacoes';
      let clientesCarregados = false;
      let CLIENTES_DATA = [];
      let CLIENTES_APENAS_SALDO = false;
      let CLIENTES_LAST_UPDATE = '';
      let HISTORICO_DATA = [];
      let HISTORICO_RESUMO = null;
      let HISTORICO_PERIODO_DATA = [];
      let HISTORICO_PERIODO_RESUMO = null;
      let HISTORICO_PERIODO_PARAM = null;
      const $ = (id)=>document.getElementById(id);
      const fmtBR = (n)=> Number(n||0).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2});
      const onlyDigits = (s)=> String(s||'').replace(/\D/g,'');
      const isVisible = (node)=> !!node && node.style.display !== 'none';

      function formatCPF(value){
        const digits = onlyDigits(value);
        if (digits.length !== 11) return value || '-';
        return digits.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
      }

      function fmtDataCurta(v){
        if(!v) return '-';
        const d = new Date(v);
        if (isNaN(d)) return '-';
        return d.toLocaleDateString('pt-BR') + ' ' + d.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
      }

      function fmtDataDia(v){
        if(!v) return '-';
        const d = new Date(v);
        if (isNaN(d)) return '-';
        return d.toLocaleDateString('pt-BR');
      }

      function clearOutputs(except){
        if(except!=='saldo')   $('outSaldo').textContent   = '';
        if(except!=='compra')  $('outCompra').textContent  = '';
        if(except!=='resgate') $('outResgate').textContent = '';
      }

      // CPF máscara
      function cpfMask(v){
        const d = onlyDigits(v).slice(0,11);
        return d.replace(/^(\d{3})(\d)/,"$1.$2")
                .replace(/^(\d{3})\.(\d{3})(\d)/,"$1.$2.$3")
                .replace(/\.(\d{3})(\d)/,".$1-$2");
      }
      function attachCpfMask(id){ const el = $(id); el.addEventListener('input', ()=>{ el.value = cpfMask(el.value); }); }

      // Moeda máscara R$
      function moneyMask(el){
        let d = el.value.replace(/\D/g,'');
        if (d.length === 0){ el.value=''; return; }
        if (d.length === 1) d = '0' + d;
        const int = d.slice(0, -2).replace(/^0+(?=\d)/,'');
        const dec = d.slice(-2);
        const intFmt = int.replace(/\B(?=(\d{3})+(?!\d))/g,'.') || '0';
        el.value = `${intFmt},${dec}`;
      }
      function attachMoneyMask(id){ const el = $(id); el.addEventListener('input', ()=> moneyMask(el)); }
      function parseMoney(v){ if(!v) return 0; return parseFloat(v.replace(/\./g,'').replace(',','.')) || 0; }
      function fmtDataHoraBR(v){
        if(!v) return '-';
        const d = new Date(v);
        if (isNaN(d)) return '-';
        return d.toLocaleDateString('pt-BR') + ' ' + d.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
      }

      // Toasts
      function toast(text, ok=true){
        const box = $('toast'); const t = document.createElement('div');
        t.className = 't ' + (ok ? 'ok' : 'err'); t.textContent = text; box.appendChild(t);
        setTimeout(()=>{ t.style.opacity='0'; t.style.transform='translateY(6px)'; }, 2800);
        setTimeout(()=>{ try{ box.removeChild(t); }catch(_){} }, 3400);
      }

      // Views
      function showLogin(){ $('loginView').style.display='block'; $('changeView').style.display='none'; $('appView').style.display='none'; $('who').textContent='—'; }
      function showChange(){ $('loginView').style.display='none'; $('changeView').style.display='block'; $('appView').style.display='none'; }
      function showApp(){
        $('loginView').style.display='none';
        $('changeView').style.display='none';
        $('appView').style.display='block';
        clientesCarregados = false;
      }

      // Tabs
      function switchTab(tab){
        currentTab = tab;
        document.querySelectorAll('.tab').forEach(t => {
          const isActive = t.dataset.tab === tab;
          if (isActive) t.classList.add('active');
          else t.classList.remove('active');
        });
        document.querySelectorAll('.tab-content').forEach(tc => tc.style.display = 'none');

        const tabMapping = {
          operacoes: 'tabOperacoes',
          dashboard: 'tabDashboard',
          clientes: 'tabClientes',
          historico: 'tabHistorico'
        };

        const targetId = tabMapping[tab];
        if (targetId && $(targetId)) {
          $(targetId).style.display = 'block';
        }

        if (tab === 'dashboard') {
          carregarDashboard();
        } else if (tab === 'clientes' && !clientesCarregados) {
          gerarRelatorioClientes();
        } else if (tab === 'historico') {
          const input = $('historicoCpf');
          if (input) {
            setTimeout(() => input.focus(), 60);
          }
        }
      }

      // Helpers de sessão no front
      function isSessionError(err){
        const s = (err && (err.msg || err.message || err.toString())) ? String(err.msg || err.message || err).toLowerCase() : '';
        return s.includes('sessão inválida') || s.includes('expirada') || s.includes('invalid session');
      }
      function forceRelog(msg){
        try{ localStorage.removeItem('cb_token'); localStorage.removeItem('cb_user'); }catch(_){}
        TOKEN = null; CURRENT_USER = null;
        showLogin();
        toast(msg || 'Sua sessão expirou. Faça login novamente.', false);
      }

      // Session restore
      (function init(){
        ['cpfSaldo','cpfCompra','cpfResgatar','historicoCpf'].forEach(attachCpfMask);
        ['valorCompra','valorResgatar'].forEach(attachMoneyMask);

        const filtroClientes = $('clientesFiltro');
        if (filtroClientes){
          filtroClientes.addEventListener('input', debounce(() => atualizarClientesTabela(), 200));
        }

        const toggleSaldo = $('clientesSomenteSaldo');
        if (toggleSaldo){
          toggleSaldo.addEventListener('change', (ev) => {
            CLIENTES_APENAS_SALDO = !!ev.target.checked;
            atualizarClientesTabela();
          });
        }

        const historicoCpfInput = $('historicoCpf');
        if (historicoCpfInput){
          historicoCpfInput.addEventListener('keydown', (ev) => {
            if (ev.key === 'Enter'){ ev.preventDefault(); buscarHistorico(); }
          });
        }

        const t = localStorage.getItem('cb_token'), u = localStorage.getItem('cb_user');
        if (t && u){ TOKEN=t; CURRENT_USER=u; $('who').textContent='Operador: '+CURRENT_USER; showApp(); }
        else { showLogin(); }
      })();

      // Debounce helper
      function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      }

      // ======== Auth ========
      function login(){
        const username = $('username').value.trim(), password = $('password').value;
        $('loginMsg').textContent='';
        google.script.run
          .withSuccessHandler(r=>{
            if(!r.ok){ $('loginMsg').textContent = r.msg || 'Falha no login'; toast(r.msg || 'Falha no login', false); return; }
            TOKEN=r.token; CURRENT_USER=r.username;
            localStorage.setItem('cb_token',TOKEN); localStorage.setItem('cb_user',CURRENT_USER);
            $('who').textContent='Operador: '+CURRENT_USER;
            if(r.must_change){ showChange(); } else { showApp(); toast('Login realizado'); }
          })
          .withFailureHandler(e=>{ $('loginMsg').textContent='Erro: '+e; toast('Erro no login', false); })
          .apiLogin({username, password});
      }
      
      function changePass(){
        const a=$('newPass').value, b=$('newPass2').value; $('changeMsg').textContent='';
        if(a.length<8){ $('changeMsg').textContent='Senha mínima de 8 caracteres.'; toast('Senha muito curta', false); return; }
        if(a!==b){ $('changeMsg').textContent='As senhas não conferem.'; toast('As senhas não conferem', false); return; }
        google.script.run
          .withSuccessHandler(r=>{
            if(!r.ok){ $('changeMsg').textContent=r.msg||'Erro ao salvar'; toast('Erro ao salvar senha', false); return; }
            showApp(); toast('Senha atualizada');
          })
          .withFailureHandler(e=>{ $('changeMsg').textContent='Erro: '+e; toast('Erro ao salvar senha', false); })
          .apiChangePassword({ username: CURRENT_USER, newPassword: a, token: TOKEN });
      }
      
      function logout(){
        google.script.run.withSuccessHandler(()=>{
          localStorage.removeItem('cb_token'); localStorage.removeItem('cb_user');
          TOKEN=null; CURRENT_USER=null; showLogin(); toast('Sessão encerrada');
        }).apiLogout({ token: TOKEN });
      }

      // ======== Modal ========
      let modalConfirmCb=null;
      function openModal(title, htmlDesc, onConfirm){
        $('modalTitle').textContent=title; $('modalDesc').innerHTML=htmlDesc;
        $('modalBackdrop').style.display='grid'; modalConfirmCb=onConfirm;
      }
      function closeModal(){ $('modalBackdrop').style.display='none'; modalConfirmCb=null; }
      document.getElementById('modalConfirmBtn').addEventListener('click', ()=>{
        if(modalConfirmCb){ const fn=modalConfirmCb; closeModal(); fn(); }
      });

      // ======== Ações ========
      function getSaldo(){
        const cpf = $('cpfSaldo').value;
        clearOutputs('saldo');
        $('outSaldo').textContent='';
        google.script.run
          .withSuccessHandler(r=>{
            if(!r.ok){
              if (isSessionError(r)) { forceRelog(r.msg); return; }
              $('outSaldo').textContent = r.msg || 'Falha'; toast(r.msg || 'Falha', false); return;
            }
            $('outSaldo').textContent = `Saldo de desconto: R$ ${fmtBR(r.saldo)}`;
          })
          .withFailureHandler(e=>{
            if (isSessionError(e)) { forceRelog('Sua sessão expirou.'); return; }
            $('outSaldo').textContent='Erro: '+e; toast('Erro ao consultar', false);
          })
          .apiGetSaldo({ token: TOKEN, cpf });
      }

      function lancar(){
        const cpf=$('cpfCompra').value, valor=parseMoney($('valorCompra').value), notaRef=$('notaRef').value;
        if(!cpf || !valor || valor<=0){ $('outCompra').textContent='Preencha CPF e um valor válido.'; toast('Campos inválidos', false); return; }

        openModal('Confirmar lançamento',
          `<p><b>CPF:</b> ${cpf}</p><p><b>Valor da compra:</b> R$ ${fmtBR(valor)}</p><p class="muted">Isso vai gerar <b>desconto</b> conforme as regras da loja.</p>`,
          function(){
            clearOutputs('compra');
            const btn=$('btnLancar'); btn.disabled=true; $('outCompra').textContent='Processando…';
            const payload={ token:TOKEN, cpf, valorCompra: valor, notaRef };
            google.script.run
              .withSuccessHandler(r=>{
                btn.disabled=false;
                if(!r.ok){
                  if (isSessionError(r)) { forceRelog(r.msg); return; }
                  $('outCompra').textContent=r.msg||'Falha ao lançar'; toast(r.msg||'Falha ao lançar', false); return;
                }
                $('outCompra').textContent=`Desconto gerado: R$ ${fmtBR(r.credito)} | Saldo de desconto: R$ ${fmtBR(r.saldoAtual)}`;
                $('valorCompra').value=''; $('notaRef').value='';
                toast('Lançamento registrado');
                if(r.limited){ toast(`Desconto limitado — gerado R$ ${fmtBR(r.credito)}.`, true); }
              })
              .withFailureHandler(e=>{
                btn.disabled=false;
                if (isSessionError(e)) { forceRelog('Sua sessão expirou.'); return; }
                $('outCompra').textContent='Erro: '+e; toast('Erro ao lançar', false);
              })
              .apiLancarCompra(payload);
          }
        );
      }

      function resgatar(){
        const cpf=$('cpfResgatar').value, valor=parseMoney($('valorResgatar').value);
        if(!cpf || !valor || valor<=0){ $('outResgate').textContent='Preencha CPF e um valor válido.'; toast('Campos inválidos', false); return; }

        openModal('Confirmar abatimento', `<p><b>CPF:</b> ${cpf}</p><p><b>Valor a abater:</b> R$ ${fmtBR(valor)}</p>`,
          function(){
            clearOutputs('resgate');
            const btn=$('btnResgatar'); btn.disabled=true; $('outResgate').textContent='Processando…';
            const payload={ token:TOKEN, cpf, valorResgate: valor };
            google.script.run
              .withSuccessHandler(r=>{
                btn.disabled=false;
                if(!r.ok){
                  if (isSessionError(r)) { forceRelog(r.msg); return; }
                  $('outResgate').textContent=r.msg||'Falha no resgate'; toast(r.msg||'Falha no resgate', false); return;
                }
                $('outResgate').textContent=`Desconto abatido: R$ ${fmtBR(r.resgatado)} | Saldo de desconto: R$ ${fmtBR(r.saldoAtual)}`;
                $('valorResgatar').value='';
                toast('Desconto abatido');
              })
              .withFailureHandler(e=>{
                btn.disabled=false;
                if (isSessionError(e)) { forceRelog('Sua sessão expirou.'); return; }
                $('outResgate').textContent='Erro: '+e; toast('Erro no resgate', false);
              })
              .apiResgatar(payload);
          }
        );
      }

      // ======== Dashboard ========
      function carregarDashboard(){
        $('dashLoading').style.display='block';
        $('dashContent').style.display='none';

        google.script.run
          .withSuccessHandler(r=>{
            $('dashLoading').style.display='none';
            if(!r.ok){
              if (isSessionError(r)) { forceRelog(r.msg); return; }
              toast('Erro ao carregar dashboard', false); return;
            }
            
            $('dashHojeTransacoes').textContent = r.hoje.transacoes;
            $('dashHojeClientes').textContent = r.hoje.clientesUnicos;
            $('dashHojeCredito').textContent = 'R$ ' + fmtBR(r.hoje.creditoGerado);
            $('dashHojeResgate').textContent = 'R$ ' + fmtBR(r.hoje.resgateFeito);
            
            $('dashMesTransacoes').textContent = r.mes.transacoes;
            $('dashMesClientes').textContent = r.mes.clientesUnicos;
            $('dashMesCredito').textContent = 'R$ ' + fmtBR(r.mes.creditoGerado);
            $('dashMesResgate').textContent = 'R$ ' + fmtBR(r.mes.resgateFeito);
            $('dashMesPendente').textContent = 'R$ ' + fmtBR(r.mes.saldoPendente);
            $('dashTotalClientes').textContent = r.totalClientes;
            
            $('dashContent').style.display='block';
          })
          .withFailureHandler(e=>{
            $('dashLoading').style.display='none';
            if (isSessionError(e)) { forceRelog(); return; }
            toast('Erro ao carregar dashboard', false);
          })
          .apiGetDashboard({ token: TOKEN });
      }

      function atualizarResumoClientes(meta){
        const metrics = $('clientesMetrics');
        if (!metrics) return;

        if (!meta){
          metrics.style.display = 'none';
          $('clientesMetricTotal').textContent = '0';
          $('clientesMetricAtivos').textContent = '0';
          $('clientesMetricSaldo').textContent = 'R$ 0,00';
          $('clientesMetricMaior').textContent = 'R$ 0,00';
          CLIENTES_LAST_UPDATE = '';
          return;
        }

        $('clientesMetricTotal').textContent = meta.totalClientes || 0;
        $('clientesMetricAtivos').textContent = meta.totalComSaldo || 0;
        $('clientesMetricSaldo').textContent = 'R$ ' + fmtBR(meta.totalSaldo || 0);
        $('clientesMetricMaior').textContent = 'R$ ' + fmtBR(meta.maiorSaldo || 0);
        CLIENTES_LAST_UPDATE = meta.atualizadoEm || new Date().toISOString();
        metrics.style.display = 'grid';
      }

      function atualizarClientesTabela(){
        const tbody = $('clientesTableBody');
        const wrap = $('clientesTableWrap');
        const emptyState = $('clientesEmpty');
        const status = $('clientesStatus');
        if (!tbody || !wrap || !emptyState || !status) return;

        const filtroInput = $('clientesFiltro');
        const filtro = filtroInput ? filtroInput.value.trim().toLowerCase() : '';
        const filtroDigits = onlyDigits(filtro);

        const listaFiltrada = CLIENTES_DATA.filter(cli => {
          const nome = String(cli.nome || '').toLowerCase();
          const cpf = String(cli.cpf || '');
          const cpfFmt = String(cli.cpf_formatado || '').toLowerCase();
          const saldoOk = !CLIENTES_APENAS_SALDO || (Number(cli.saldo_centavos || 0) > 0);
          if (!filtro) return saldoOk;
          const cpfMatch = cpf.includes(filtroDigits) || cpfFmt.includes(filtro);
          const nomeMatch = nome.includes(filtro);
          return saldoOk && (cpfMatch || nomeMatch);
        });

        tbody.innerHTML = '';
        listaFiltrada.forEach((cli, idx) => {
          const tr = document.createElement('tr');
          const saldoFmt = 'R$ ' + fmtBR(cli.saldo || 0);
          tr.innerHTML = `
            <td>${idx + 1}</td>
            <td>${cli.cpf_formatado || formatCPF(cli.cpf)}</td>
            <td>${cli.nome || '-'}</td>
            <td>${cli.telefone || '-'}</td>
            <td>${saldoFmt}</td>
            <td>${fmtDataCurta(cli.ultimo_uso)}</td>
            <td>${fmtDataDia(cli.criado_em)}</td>
          `;
          tbody.appendChild(tr);
        });

        if (listaFiltrada.length){
          wrap.style.display = 'block';
          emptyState.style.display = 'none';
        } else {
          wrap.style.display = 'none';
          emptyState.textContent = CLIENTES_DATA.length
            ? 'Nenhum cliente corresponde ao filtro aplicado.'
            : 'Nenhum cliente encontrado na planilha.';
          emptyState.style.display = 'block';
        }

        const exibidos = listaFiltrada.length;
        const baseMsg = exibidos
          ? `${exibidos} cliente${exibidos > 1 ? 's' : ''} exibido${exibidos > 1 ? 's' : ''}.`
          : (CLIENTES_DATA.length
            ? 'Nenhum cliente corresponde ao filtro aplicado.'
            : 'Nenhum cliente encontrado na planilha.');
        const atualizado = CLIENTES_LAST_UPDATE ? ` • Atualizado em ${fmtDataCurta(CLIENTES_LAST_UPDATE)}` : '';
        status.textContent = baseMsg + atualizado;
      }

      function gerarRelatorioClientes(){
        const btn = $('btnRelatorioClientes');
        const status = $('clientesStatus');
        const wrap = $('clientesTableWrap');
        const tbody = $('clientesTableBody');
        const emptyState = $('clientesEmpty');

        const metrics = $('clientesMetrics');
        const toolbar = $('clientesToolbar');

        if (status) status.textContent = 'Atualizando lista de clientes...';
        wrap.style.display = 'none';
        emptyState.style.display = 'none';
        tbody.innerHTML = '';
        CLIENTES_DATA = [];
        CLIENTES_LAST_UPDATE = '';
        if (metrics) metrics.style.display = 'none';
        if (toolbar) toolbar.style.display = 'none';
        if (btn) btn.disabled = true;

        try {
          google.script.run
            .withSuccessHandler(r => {
              if (btn) btn.disabled = false;
              if(!r.ok){
                status.textContent = r.msg || 'Falha ao carregar clientes.';
                toast(r.msg || 'Erro ao carregar clientes', false);
                return;
              }

              const clientes = Array.isArray(r.clientes) ? r.clientes : [];
              CLIENTES_DATA = clientes.map(cli => ({
                cpf: cli.cpf,
                cpf_formatado: cli.cpf_formatado,
                nome: cli.nome,
                telefone: cli.telefone,
                saldo: Number(cli.saldo || ((cli.saldo_centavos || 0) / 100)),
                saldo_centavos: Number(cli.saldo_centavos || Math.round((cli.saldo || 0) * 100)),
                ultimo_uso: cli.ultimo_uso,
                criado_em: cli.criado_em
              }));

              atualizarResumoClientes(r.meta);

              if (CLIENTES_DATA.length){
                if (toolbar) toolbar.style.display = 'flex';
                if (emptyState) emptyState.style.display = 'none';
                CLIENTES_APENAS_SALDO = !!($('clientesSomenteSaldo') && $('clientesSomenteSaldo').checked);
                atualizarClientesTabela();
              } else {
                if (emptyState) {
                  emptyState.textContent = 'Nenhum cliente encontrado na aba Customers.';
                  emptyState.style.display = 'block';
                }
                const atualizado = CLIENTES_LAST_UPDATE ? ` • Atualizado em ${fmtDataCurta(CLIENTES_LAST_UPDATE)}` : '';
                status.textContent = 'Nenhum cliente encontrado na aba Customers.' + atualizado;
              }

              clientesCarregados = true;
            })
            .withFailureHandler(e => {
              if (btn) btn.disabled = false;
              status.textContent = 'Erro ao carregar clientes.';
              if (isSessionError(e)) { forceRelog('Sua sessão expirou.'); return; }
              toast('Erro ao carregar clientes', false);
            })
            .apiGetClientesRelatorio({ token: TOKEN });
        } catch(err) {
          if (btn) btn.disabled = false;
          status.textContent = 'Erro ao carregar clientes.';
          toast('Erro ao carregar clientes', false);
            console.error('Falha ao iniciar geração do relatório:', err);
        }
      }

      function historicoBadge(tipo){
        const t = String(tipo || '').toUpperCase();
        if (t === 'CREDITO') return { className: 'badge badge-credit', label: 'Compra' };
        if (t === 'RESGATE') return { className: 'badge badge-resgate', label: 'Resgate' };
        return { className: 'badge badge-ajuste', label: t || 'Ajuste' };
      }

      function atualizarHistoricoResumo(resumo){
        const wrap = $('historicoResumo');
        if (!wrap) return;

        const nomeEl = $('historicoMetricNome');
        const cpfEl = $('historicoMetricCpf');
        const saldoEl = $('historicoMetricSaldo');
        const faturadoEl = $('historicoMetricFaturado');
        const geradoEl = $('historicoMetricGerado');
        const resgatadoEl = $('historicoMetricResgatado');
        const movEl = $('historicoMetricMovimentos');

        if (!resumo){
          wrap.style.display = 'none';
          if (nomeEl) nomeEl.textContent = '-';
          if (cpfEl) cpfEl.textContent = 'CPF não informado';
          if (saldoEl) saldoEl.textContent = 'R$ 0,00';
          if (faturadoEl) faturadoEl.textContent = 'R$ 0,00';
          if (geradoEl) geradoEl.textContent = 'R$ 0,00';
          if (resgatadoEl) resgatadoEl.textContent = 'R$ 0,00';
          if (movEl) movEl.textContent = '0';
          return;
        }

        const saldoAtual = resumo.saldoAtual !== undefined
          ? Number(resumo.saldoAtual || 0)
          : (resumo.saldoCentavos !== undefined ? Number(resumo.saldoCentavos || 0) / 100 : 0);
        const totalFaturado = resumo.totalFaturado !== undefined
          ? Number(resumo.totalFaturado || 0)
          : (resumo.totalFaturadoCentavos !== undefined ? Number(resumo.totalFaturadoCentavos || 0) / 100 : 0);
        const totalGerado = resumo.totalGerado !== undefined
          ? Number(resumo.totalGerado || 0)
          : (resumo.totalGeradoCentavos !== undefined ? Number(resumo.totalGeradoCentavos || 0) / 100 : 0);
        const totalResgatado = resumo.totalResgatado !== undefined
          ? Number(resumo.totalResgatado || 0)
          : (resumo.totalResgatadoCentavos !== undefined ? Number(resumo.totalResgatadoCentavos || 0) / 100 : 0);
        const movimentos = resumo.movimentos !== undefined ? Number(resumo.movimentos || 0) : 0;

        if (nomeEl) nomeEl.textContent = resumo.nome || '—';
        if (cpfEl) cpfEl.textContent = resumo.cpf ? formatCPF(resumo.cpf) : 'CPF não informado';
        if (saldoEl) saldoEl.textContent = 'R$ ' + fmtBR(saldoAtual);
        if (faturadoEl) faturadoEl.textContent = 'R$ ' + fmtBR(totalFaturado);
        if (geradoEl) geradoEl.textContent = 'R$ ' + fmtBR(totalGerado);
        if (resgatadoEl) resgatadoEl.textContent = 'R$ ' + fmtBR(totalResgatado);
        if (movEl) movEl.textContent = movimentos;

        wrap.style.display = 'grid';
      }

      function atualizarHistoricoTabela(){
        const tbody = $('historicoTableBody');
        const wrap = $('historicoTableWrap');
        const empty = $('historicoEmpty');
        if (!tbody || !wrap || !empty) return;

        tbody.innerHTML = '';

        HISTORICO_DATA.forEach(item => {
          const tipo = String(item.tipo || '').toUpperCase();
          const badge = historicoBadge(tipo);
          const tr = document.createElement('tr');

          const dataFmt = fmtDataHoraBR(item.data);
          const dataTexto = dataFmt !== '-' ? dataFmt : (item.dataDisplay || '-');

          const compraVal = (tipo === 'CREDITO' && item.valorCompra !== null && item.valorCompra !== undefined)
            ? 'R$ ' + fmtBR(item.valorCompra || 0)
            : '—';

          let valorTexto;
          const valorNumero = Number(item.valor || 0);
          if (tipo === 'CREDITO'){
            valorTexto = 'R$ ' + fmtBR(valorNumero);
          } else if (tipo === 'RESGATE'){
            valorTexto = 'R$ ' + fmtBR(Math.abs(valorNumero));
          } else {
            const sinal = valorNumero >= 0 ? '+' : '-';
            valorTexto = `${sinal} R$ ${fmtBR(Math.abs(valorNumero))}`;
          }

          tr.innerHTML = `
            <td>${dataTexto}</td>
            <td><span class="${badge.className}">${badge.label}</span></td>
            <td>${compraVal}</td>
            <td>${valorTexto}</td>
            <td>${item.operador || '-'}</td>
            <td>${item.nota || '-'}</td>
            <td></td>
          `;
          const actionsTd = tr.lastElementChild;
          if (actionsTd){
            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'btn btn-ghost btn-small';
            cancelBtn.type = 'button';
            cancelBtn.textContent = 'Cancelar';
            cancelBtn.addEventListener('click', () => {
              const cpfAlvo = item.cpf || (HISTORICO_RESUMO ? HISTORICO_RESUMO.cpf : '');
              confirmarCancelamentoTransacao({
                rowIndex: item.rowIndex,
                cpf: cpfAlvo,
                descricao: `${dataTexto} • ${badge.label}`,
                contexto: 'historico-cpf'
              });
            });
            actionsTd.appendChild(cancelBtn);
          }
          tbody.appendChild(tr);
        });

        if (HISTORICO_DATA.length){
          wrap.style.display = 'block';
          empty.style.display = 'none';
        } else {
          wrap.style.display = 'none';
          empty.style.display = 'block';
        }
      }

      function limparHistoricoUI(){
        HISTORICO_DATA = [];
        HISTORICO_RESUMO = null;
        const tbody = $('historicoTableBody');
        if (tbody) tbody.innerHTML = '';
        const wrap = $('historicoTableWrap');
        if (wrap) wrap.style.display = 'none';
        const empty = $('historicoEmpty');
        if (empty) empty.style.display = 'none';
        atualizarHistoricoResumo(null);
      }

      function confirmarCancelamentoTransacao({ rowIndex, cpf, descricao, contexto }){
        const statusEl = contexto === 'historico-cpf'
          ? $('historicoStatus')
          : $('historicoPeriodoStatus');

        if (!rowIndex || !cpf){
          if (statusEl) statusEl.textContent = 'Não foi possível identificar a transação selecionada.';
          toast('Não foi possível identificar a transação selecionada.', false);
          return;
        }

        const detalhes = descricao ? `<p><strong>${descricao}</strong></p>` : '';
        openModal(
          'Cancelar transação',
          `<p>Confirma cancelar esta transação?</p>${detalhes}<p class="muted">O registro será removido e o saldo atualizado automaticamente.</p>`,
          () => {
            if (statusEl) statusEl.textContent = 'Cancelando transação...';
            google.script.run
              .withSuccessHandler(r => {
                if (!r || !r.ok){
                  if (isSessionError(r)) { forceRelog(r && r.msg ? r.msg : 'Sessão expirada.'); return; }
                  if (statusEl) statusEl.textContent = (r && r.msg) ? r.msg : 'Erro ao cancelar transação.';
                  toast((r && r.msg) ? r.msg : 'Erro ao cancelar transação', false);
                  return;
                }

                toast('Transação cancelada.');

                if (contexto === 'historico-cpf'){
                  if (statusEl) statusEl.textContent = 'Transação cancelada. Recarregando histórico...';
                  buscarHistorico();
                } else if (contexto === 'historico-periodo'){
                  if (statusEl) statusEl.textContent = 'Transação cancelada. Atualizando lista...';
                  buscarHistoricoPeriodo(true);
                } else {
                  if (statusEl) statusEl.textContent = '';
                }
              })
              .withFailureHandler(e => {
                if (isSessionError(e)) { forceRelog('Sua sessão expirou.'); return; }
                if (statusEl) statusEl.textContent = 'Erro ao cancelar transação.';
                toast('Erro ao cancelar transação', false);
              })
              .apiCancelarTransacao({ token: TOKEN, cpf, rowIndex });
          }
        );
      }

      function buscarHistorico(){
        const input = $('historicoCpf');
        const status = $('historicoStatus');
        const btn = $('btnHistorico');
        const cpfDigitado = input ? input.value : '';
        const cpfLimpo = onlyDigits(cpfDigitado);

        if (cpfLimpo.length !== 11){
          if (status) status.textContent = 'Informe um CPF válido com 11 dígitos.';
          toast('Informe um CPF válido.', false);
          return;
        }

        limparHistoricoUI();

        if (status) status.textContent = 'Consultando histórico...';
        if (btn) btn.disabled = true;

        google.script.run
          .withSuccessHandler(r => {
            if (btn) btn.disabled = false;
            if (!r || !r.ok){
              if (isSessionError(r)) { forceRelog(r && r.msg ? r.msg : 'Sessão expirada.'); return; }
              if (status) status.textContent = (r && r.msg) ? r.msg : 'Erro ao consultar histórico.';
              toast((r && r.msg) ? r.msg : 'Erro ao consultar histórico', false);
              return;
            }

            const historico = Array.isArray(r.historico) ? r.historico : [];

            HISTORICO_DATA = historico.map(item => ({
              data: item.data || item.dataISO || item.timestamp || '',
              dataDisplay: item.dataDisplay || item.dataTexto || '',
              tipo: item.tipo,
              valor: Number(item.valor !== undefined ? item.valor : (item.valorCentavos !== undefined ? item.valorCentavos / 100 : 0)),
              valorCentavos: item.valorCentavos !== undefined ? Number(item.valorCentavos || 0) : undefined,
              valorCompra: item.valorCompra === null || item.valorCompra === undefined
                ? null
                : Number(item.valorCompra || 0),
              valorCompraCentavos: item.valorCompraCentavos === null || item.valorCompraCentavos === undefined
                ? null
                : Number(item.valorCompraCentavos || 0),
              operador: item.operador || '',
              nota: item.nota || '',
              observacoes: item.observacoes || '',
              rowIndex: Number(item.rowIndex || 0),
              cpf: item.cpf || cpfLimpo
            }));

            let totalFaturadoCalc = 0;
            let totalGeradoCalc = 0;
            let totalResgatadoCalc = 0;

            HISTORICO_DATA.forEach(item => {
              const tipo = String(item.tipo || '').toUpperCase();
              const valorNumero = Number(item.valor || 0);
              if (tipo === 'CREDITO'){
                if (item.valorCompra !== null && item.valorCompra !== undefined){
                  totalFaturadoCalc += Number(item.valorCompra || 0);
                }
                totalGeradoCalc += valorNumero;
              } else if (tipo === 'RESGATE'){
                totalResgatadoCalc += Math.abs(valorNumero);
              } else {
                if (valorNumero >= 0) totalGeradoCalc += valorNumero;
                else totalResgatadoCalc += Math.abs(valorNumero);
              }
            });

            const resumoResposta = r.resumo || {};

            const saldoAtual = resumoResposta.saldoAtual !== undefined
              ? Number(resumoResposta.saldoAtual || 0)
              : (resumoResposta.saldoCentavos !== undefined
                  ? Number(resumoResposta.saldoCentavos || 0) / 100
                  : Number(r.saldoAtual || 0));

            const totalFaturado = resumoResposta.totalFaturado !== undefined
              ? Number(resumoResposta.totalFaturado || 0)
              : (resumoResposta.totalFaturadoCentavos !== undefined
                  ? Number(resumoResposta.totalFaturadoCentavos || 0) / 100
                  : totalFaturadoCalc);

            const totalGerado = resumoResposta.totalGerado !== undefined
              ? Number(resumoResposta.totalGerado || 0)
              : (resumoResposta.totalGeradoCentavos !== undefined
                  ? Number(resumoResposta.totalGeradoCentavos || 0) / 100
                  : totalGeradoCalc);

            const totalResgatado = resumoResposta.totalResgatado !== undefined
              ? Number(resumoResposta.totalResgatado || 0)
              : (resumoResposta.totalResgatadoCentavos !== undefined
                  ? Number(resumoResposta.totalResgatadoCentavos || 0) / 100
                  : totalResgatadoCalc);

            const movimentos = resumoResposta.movimentos !== undefined
              ? Number(resumoResposta.movimentos || 0)
              : HISTORICO_DATA.length;

            HISTORICO_RESUMO = {
              cpf: resumoResposta.cpf || r.cpf || cpfLimpo,
              nome: resumoResposta.nome !== undefined ? resumoResposta.nome : (r.nome || ''),
              saldoAtual,
              saldoCentavos: resumoResposta.saldoCentavos !== undefined ? Number(resumoResposta.saldoCentavos || 0) : undefined,
              totalFaturado,
              totalFaturadoCentavos: resumoResposta.totalFaturadoCentavos !== undefined ? Number(resumoResposta.totalFaturadoCentavos || 0) : undefined,
              totalGerado,
              totalGeradoCentavos: resumoResposta.totalGeradoCentavos !== undefined ? Number(resumoResposta.totalGeradoCentavos || 0) : undefined,
              totalResgatado,
              totalResgatadoCentavos: resumoResposta.totalResgatadoCentavos !== undefined ? Number(resumoResposta.totalResgatadoCentavos || 0) : undefined,
              movimentos
            };

            atualizarHistoricoResumo(HISTORICO_RESUMO);
            atualizarHistoricoTabela();

            if (status){
              const movCount = HISTORICO_RESUMO ? Number(HISTORICO_RESUMO.movimentos || 0) : HISTORICO_DATA.length;
              if (movCount > 0){
                const plural = movCount > 1 ? 'movimentações' : 'movimentação';
                status.textContent = `${movCount} ${plural} encontradas.`;
              } else {
                status.textContent = 'Nenhuma movimentação encontrada para este CPF.';
              }
            }
          })
          .withFailureHandler(e => {
            if (btn) btn.disabled = false;
            if (isSessionError(e)) { forceRelog('Sua sessão expirou.'); return; }
            if (status) status.textContent = 'Erro ao consultar histórico.';
            toast('Erro ao consultar histórico', false);
          })
          .apiGetHistorico({ token: TOKEN, cpf: cpfLimpo });
      }

      function limparHistoricoPeriodoUI(){
        HISTORICO_PERIODO_DATA = [];
        HISTORICO_PERIODO_RESUMO = null;
        const tbody = $('historicoPeriodoTableBody');
        if (tbody) tbody.innerHTML = '';
        const wrap = $('historicoPeriodoTableWrap');
        if (wrap) wrap.style.display = 'none';
        const empty = $('historicoPeriodoEmpty');
        if (empty) empty.style.display = 'none';
        atualizarHistoricoPeriodoResumo(null);
      }

      function atualizarHistoricoPeriodoResumo(resumo){
        const wrap = $('historicoPeriodoResumo');
        if (!wrap) return;

        const intervaloEl = $('historicoPeriodoIntervalo');
        const movEl = $('historicoPeriodoMovimentos');
        const creditoEl = $('historicoPeriodoCredito');
        const resgateEl = $('historicoPeriodoResgate');
        const liquidoEl = $('historicoPeriodoLiquido');

        if (!resumo){
          wrap.style.display = 'none';
          if (intervaloEl) intervaloEl.textContent = '-';
          if (movEl) movEl.textContent = '0';
          if (creditoEl) creditoEl.textContent = 'R$ 0,00';
          if (resgateEl) resgateEl.textContent = 'R$ 0,00';
          if (liquidoEl) liquidoEl.textContent = 'R$ 0,00';
          return;
        }

        const inicioIso = resumo.periodoInicio || (HISTORICO_PERIODO_PARAM ? HISTORICO_PERIODO_PARAM.inicioIso : '');
        const fimIso = resumo.periodoFim || (HISTORICO_PERIODO_PARAM ? HISTORICO_PERIODO_PARAM.fimIso : '');
        const inicioFmt = inicioIso ? fmtDataDia(inicioIso) : '-';
        const fimFmt = fimIso ? fmtDataDia(fimIso) : '-';

        const movimentos = resumo.movimentos !== undefined ? Number(resumo.movimentos || 0) : 0;
        const totalCredito = resumo.totalCredito !== undefined
          ? Number(resumo.totalCredito || 0)
          : (resumo.totalCreditoCentavos !== undefined ? Number(resumo.totalCreditoCentavos || 0) / 100 : 0);
        const totalResgate = resumo.totalResgate !== undefined
          ? Number(resumo.totalResgate || 0)
          : (resumo.totalResgateCentavos !== undefined ? Number(resumo.totalResgateCentavos || 0) / 100 : 0);
        const totalAjuste = resumo.totalAjuste !== undefined
          ? Number(resumo.totalAjuste || 0)
          : (resumo.totalAjusteCentavos !== undefined ? Number(resumo.totalAjusteCentavos || 0) / 100 : 0);
        const totalLiquido = resumo.totalLiquido !== undefined
          ? Number(resumo.totalLiquido || 0)
          : (resumo.totalLiquidoCentavos !== undefined ? Number(resumo.totalLiquidoCentavos || 0) / 100 : 0);

        const resgateEAjustes = totalResgate + (totalAjuste < 0 ? Math.abs(totalAjuste) : 0);

        if (intervaloEl) intervaloEl.textContent = `${inicioFmt} — ${fimFmt}`;
        if (movEl) movEl.textContent = movimentos;
        if (creditoEl) creditoEl.textContent = 'R$ ' + fmtBR(totalCredito);
        if (resgateEl) resgateEl.textContent = 'R$ ' + fmtBR(resgateEAjustes);
        if (liquidoEl) liquidoEl.textContent = 'R$ ' + fmtBR(totalLiquido);

        wrap.style.display = 'grid';
      }

      function atualizarHistoricoPeriodoTabela(){
        const tbody = $('historicoPeriodoTableBody');
        const wrap = $('historicoPeriodoTableWrap');
        const empty = $('historicoPeriodoEmpty');
        if (!tbody || !wrap || !empty) return;

        tbody.innerHTML = '';

        HISTORICO_PERIODO_DATA.forEach(item => {
          const tipo = String(item.tipo || '').toUpperCase();
          const badge = historicoBadge(tipo);
          const tr = document.createElement('tr');

          const dataFmt = fmtDataHoraBR(item.data);
          const dataTexto = dataFmt !== '-' ? dataFmt : (item.dataDisplay || '-');
          const cpfTexto = item.cpf ? formatCPF(item.cpf) : '-';

          const compraVal = (tipo === 'CREDITO' && item.valorCompra !== null && item.valorCompra !== undefined)
            ? 'R$ ' + fmtBR(item.valorCompra || 0)
            : '—';

          let valorTexto;
          const valorNumero = Number(item.valor || 0);
          if (tipo === 'CREDITO'){
            valorTexto = 'R$ ' + fmtBR(valorNumero);
          } else if (tipo === 'RESGATE'){
            valorTexto = 'R$ ' + fmtBR(Math.abs(valorNumero));
          } else {
            const sinal = valorNumero >= 0 ? '+' : '-';
            valorTexto = `${sinal} R$ ${fmtBR(Math.abs(valorNumero))}`;
          }

          tr.innerHTML = `
            <td>${dataTexto}</td>
            <td>${cpfTexto}</td>
            <td><span class="${badge.className}">${badge.label}</span></td>
            <td>${compraVal}</td>
            <td>${valorTexto}</td>
            <td>${item.operador || '-'}</td>
            <td>${item.nota || '-'}</td>
            <td></td>
          `;

          const actionsTd = tr.lastElementChild;
          if (actionsTd){
            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'btn btn-ghost btn-small';
            cancelBtn.type = 'button';
            cancelBtn.textContent = 'Cancelar';
            cancelBtn.addEventListener('click', () => {
              const descricao = `${dataTexto} • ${badge.label} (${cpfTexto})`;
              confirmarCancelamentoTransacao({
                rowIndex: item.rowIndex,
                cpf: item.cpf,
                descricao,
                contexto: 'historico-periodo'
              });
            });
            actionsTd.appendChild(cancelBtn);
          }

          tbody.appendChild(tr);
        });

        if (HISTORICO_PERIODO_DATA.length){
          wrap.style.display = 'block';
          empty.style.display = 'none';
        } else {
          wrap.style.display = 'none';
          empty.style.display = 'block';
        }
      }

      function buscarHistoricoPeriodo(reload=false){
        const status = $('historicoPeriodoStatus');
        const btn = $('btnHistoricoPeriodo');
        const inicioInput = $('historicoInicio');
        const fimInput = $('historicoFim');

        let inicioIso;
        let fimIso;
        let inicioValor;
        let fimValor;

        if (reload){
          if (!HISTORICO_PERIODO_PARAM){
            if (status) status.textContent = 'Selecione um período para consultar.';
            return;
          }
          ({ inicioIso, fimIso, inicioValor, fimValor } = HISTORICO_PERIODO_PARAM);
        } else {
          inicioValor = inicioInput ? inicioInput.value : '';
          fimValor = fimInput ? fimInput.value : '';

          if (!inicioValor || !fimValor){
            if (status) status.textContent = 'Informe as datas inicial e final.';
            toast('Informe as datas inicial e final.', false);
            return;
          }

          const inicioDate = new Date(`${inicioValor}T00:00:00`);
          const fimDate = new Date(`${fimValor}T23:59:59`);

          if (isNaN(inicioDate) || isNaN(fimDate)){
            if (status) status.textContent = 'Datas inválidas. Verifique o período informado.';
            toast('Datas inválidas. Verifique o período informado.', false);
            return;
          }

          if (fimDate.getTime() < inicioDate.getTime()){
            if (status) status.textContent = 'A data final deve ser igual ou posterior à inicial.';
            toast('A data final deve ser igual ou posterior à inicial.', false);
            return;
          }

          inicioIso = inicioDate.toISOString();
          fimIso = fimDate.toISOString();

          HISTORICO_PERIODO_PARAM = {
            inicioIso,
            fimIso,
            inicioValor,
            fimValor
          };
        }

        if (status) status.textContent = reload ? 'Atualizando período selecionado...' : 'Consultando histórico do período...';
        if (btn) btn.disabled = true;

        limparHistoricoPeriodoUI();

        google.script.run
          .withSuccessHandler(r => {
            if (btn) btn.disabled = false;

            if (!r || !r.ok){
              if (isSessionError(r)) { forceRelog(r && r.msg ? r.msg : 'Sessão expirada.'); return; }
              if (status) status.textContent = (r && r.msg) ? r.msg : 'Erro ao consultar histórico do período.';
              toast((r && r.msg) ? r.msg : 'Erro ao consultar histórico do período', false);
              return;
            }

            const historico = Array.isArray(r.historico) ? r.historico : [];
            HISTORICO_PERIODO_DATA = historico.map(item => ({
              data: item.data || item.dataISO || item.timestamp || '',
              dataDisplay: item.dataDisplay || item.dataTexto || '',
              tipo: item.tipo,
              cpf: item.cpf || '',
              valor: Number(item.valor !== undefined ? item.valor : (item.valorCentavos !== undefined ? item.valorCentavos / 100 : 0)),
              valorCentavos: item.valorCentavos !== undefined ? Number(item.valorCentavos || 0) : undefined,
              valorCompra: item.valorCompra === null || item.valorCompra === undefined
                ? null
                : Number(item.valorCompra || 0),
              valorCompraCentavos: item.valorCompraCentavos === null || item.valorCompraCentavos === undefined
                ? null
                : Number(item.valorCompraCentavos || 0),
              operador: item.operador || '',
              nota: item.nota || '',
              observacoes: item.observacoes || '',
              rowIndex: Number(item.rowIndex || 0)
            }));

            HISTORICO_PERIODO_RESUMO = r.resumo || null;
            atualizarHistoricoPeriodoResumo(HISTORICO_PERIODO_RESUMO);
            atualizarHistoricoPeriodoTabela();

            if (status){
              if (HISTORICO_PERIODO_DATA.length){
                const inicioFmt = HISTORICO_PERIODO_PARAM ? fmtDataDia(HISTORICO_PERIODO_PARAM.inicioIso) : 'início';
                const fimFmt = HISTORICO_PERIODO_PARAM ? fmtDataDia(HISTORICO_PERIODO_PARAM.fimIso) : 'fim';
                const movCount = HISTORICO_PERIODO_DATA.length;
                const plural = movCount > 1 ? 'movimentações' : 'movimentação';
                status.textContent = `${movCount} ${plural} entre ${inicioFmt} e ${fimFmt}.`;
              } else {
                status.textContent = 'Nenhuma transação encontrada para o período selecionado.';
              }
            }
          })
          .withFailureHandler(e => {
            if (btn) btn.disabled = false;
            if (isSessionError(e)) { forceRelog('Sua sessão expirou.'); return; }
            if (status) status.textContent = 'Erro ao consultar histórico do período.';
            toast('Erro ao consultar histórico do período', false);
          })
          .apiGetHistoricoPeriodo({ token: TOKEN, inicio: inicioIso, fim: fimIso });
      }

    </script>
  </body>
</html>
